<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CaldaCerta Pro - Completo</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Sora:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <!-- API Configuration -->
    <script src="api-config.js"></script>

    <style>
        :root {
            --primary: #0f766e;
            --primary-dark: #065f46;
            --primary-light: #14b8a6;
            --accent: #f59e0b;
            --bg: #fafaf9;
            --card: #ffffff;
            --text: #0c0a09;
            --text-muted: #78716c;
            --border: #e7e5e4;
            --success: #15803d;
            --error: #dc2626;
            --warning: #ea580c;
        }

        * { 
            box-sizing: border-box; 
            margin: 0;
            padding: 0;
        }
        
        body { 
            font-family: 'Sora', sans-serif; 
            background: linear-gradient(135deg, #fafaf9 0%, #f5f5f4 100%);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
        }

        .mono { font-family: 'Space Mono', monospace; }

        /* Layout */
        .container {
            max-width: 64rem;
            margin: 0 auto;
            padding: 1rem;
            padding-bottom: 8rem;
        }

        .grid { display: grid; gap: 1rem; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-1 { gap: 0.25rem; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .gap-6 { gap: 1.5rem; }

        /* Typography */
        .text-xs { font-size: 0.75rem; }
        .text-sm { font-size: 0.875rem; }
        .text-base { font-size: 1rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-3xl { font-size: 1.875rem; }
        .text-4xl { font-size: 2.25rem; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        .font-black { font-weight: 800; }
        .uppercase { text-transform: uppercase; }
        .text-center { text-align: center; }
        .text-slate-500 { color: #64748b; }
        .text-slate-600 { color: #475569; }
        .text-slate-700 { color: #334155; }
        .text-slate-800 { color: #1e293b; }
        .text-slate-900 { color: #0f172a; }
        .text-white { color: white; }
        .text-teal-600 { color: var(--primary); }
        .text-red-600 { color: var(--error); }

        /* Spacing */
        .m-0 { margin: 0; }
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .ml-1 { margin-left: 0.25rem; }
        .mr-1 { margin-right: 0.25rem; }
        .mr-2 { margin-right: 0.5rem; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
        .py-16 { padding-top: 4rem; padding-bottom: 4rem; }
        .pb-1 { padding-bottom: 0.25rem; }

        /* Forms */
        .input-box { 
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: white;
            font-weight: 600;
            font-size: 1rem;
            color: var(--text);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            outline: none;
            font-family: 'Sora', sans-serif;
        }
        
        .input-box:focus { 
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(15, 118, 110, 0.1);
            transform: translateY(-2px);
        }
        
        .input-box:hover:not(:focus) {
            border-color: var(--primary-light);
        }

        .label-text { 
            display: block;
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
            margin-left: 0.25rem;
        }

        /* Cards */
        .card { 
            background: var(--card);
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05), 0 10px 30px rgba(0,0,0,0.02);
            border: 1px solid var(--border);
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.05), 0 15px 40px rgba(0,0,0,0.05);
            transform: translateY(-2px);
        }

        .card-compact { padding: 1rem; }
        .card-medium { padding: 1.5rem; }

        /* Buttons */
        .btn {
            border: none;
            cursor: pointer;
            font-family: 'Sora', sans-serif;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 0.875rem;
            letter-spacing: 0.05em;
            box-shadow: 0 4px 12px rgba(15, 118, 110, 0.3);
            gap: 0.5rem;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(15, 118, 110, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: white;
            color: var(--text);
            border: 2px solid var(--border);
            padding: 1rem 2rem;
            border-radius: 12px;
            font-weight: 700;
            gap: 0.5rem;
        }

        .btn-secondary:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-full { width: 100%; }

        /* Menu Cards */
        .menu-card {
            background: linear-gradient(135deg, var(--card) 0%, #fafafa 100%);
            border: 2px solid var(--border);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .menu-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .menu-card:hover::before {
            opacity: 0.05;
        }

        .menu-card:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: 0 10px 40px rgba(15, 118, 110, 0.15);
        }

        .icon-box {
            width: 4rem;
            height: 4rem;
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            color: white;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .menu-card:hover .icon-box {
            transform: scale(1.1) rotate(5deg);
        }

        .icon-box-green {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        /* Product Items - Drag and Drop */
        .product-item {
            background: white;
            padding: 1rem;
            border-radius: 12px;
            border-left: 4px solid var(--primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            animation: slideIn 0.3s ease;
            margin-bottom: 0.75rem;
            cursor: move;
            min-height: 80px;
            touch-action: none;
        }

        .product-item.sortable-ghost {
            opacity: 0.4;
            background: #f0fdfa;
        }

        .product-item.sortable-drag {
            opacity: 1;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transform: scale(1.05);
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .product-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateX(4px);
        }

        .drag-handle {
            cursor: grab;
            color: #cbd5e1;
            font-size: 1.5rem;
            margin-right: 0.75rem;
            padding: 0.5rem;
            touch-action: none;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        /* Container com overflow para mobile */
        .ordem-scroll-container {
            overflow-x: auto;
            margin-left: -1rem;
            margin-right: -1rem;
            padding-left: 1rem;
            padding-right: 1rem;
            -webkit-overflow-scrolling: touch;
        }

        .ordem-inner {
            min-width: 600px;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .badge-primary { background: #ccfbf1; color: var(--primary-dark); }
        .badge-accent { background: #fef3c7; color: #92400e; }
        .badge-warning { background: #fed7aa; color: #9a3412; }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-danger { background: #fecaca; color: #991b1b; }

        /* Section Headers */
        .section-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 3px solid var(--primary);
        }

        .section-number {
            width: 3rem;
            height: 3rem;
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }

        /* Progress Bar */
        .progress-bar {
            height: 4px;
            background: var(--border);
            border-radius: 9999px;
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-light), var(--primary));
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Stat Box */
        .stat-box {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            padding: 2rem;
            border-radius: 20px;
            color: white;
            text-align: center;
            box-shadow: 0 10px 30px rgba(15, 118, 110, 0.3);
        }

        .stat-label {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 3rem;
            font-weight: 800;
            font-family: 'Space Mono', monospace;
        }

        /* Alert Box */
        .alert {
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            border-left: 4px solid;
        }

        .alert-success {
            background: #d1fae5;
            border-color: #10b981;
            color: #065f46;
        }

        .alert-warning {
            background: #fed7aa;
            border-color: #f59e0b;
            color: #9a3412;
        }

        .alert-danger {
            background: #fecaca;
            border-color: #ef4444;
            color: #991b1b;
        }

        .alert-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: var(--success);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 9999;
            animation: slideInRight 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
            font-weight: 700;
        }

        @keyframes slideInRight {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeOut {
            to { opacity: 0; transform: translateY(-20px); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 4rem;
            opacity: 0.3;
            margin-bottom: 1rem;
        }

        /* Search Box */
        .search-box {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .search-box i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        .search-box input {
            padding-left: 3rem;
        }

        /* Navigation */
        nav {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .nav-container {
            max-width: 64rem;
            margin: 0 auto;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            font-size: 1.5rem;
            letter-spacing: -0.02em;
            cursor: pointer;
        }

        .user-badge {
            font-size: 0.75rem;
            background: rgba(255,255,255,0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            color: white;
            font-weight: 600;
        }

        /* Chart Container */
        .chart-container {
            background: white;
            padding: 1.5rem;
            border-radius: 16px;
            border: 1px solid var(--border);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 1.5rem;
        }

        /* Step Content */
        .step-content { 
            display: none;
            opacity: 0;
            transform: translateY(20px);
        }
        
        .step-content.active { 
            display: block;
            animation: fadeInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        @keyframes fadeInUp { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* Footer Navigation */
        footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 2px solid var(--border);
            padding: 1.5rem;
            z-index: 100;
            box-shadow: 0 -2px 20px rgba(0,0,0,0.1);
        }

        .footer-container {
            max-width: 64rem;
            margin: 0 auto;
            display: flex;
            gap: 1rem;
        }

        .footer-container .btn {
            flex: 1;
        }

        .footer-container .btn-primary {
            flex: 2;
        }

        .hidden { display: none !important; }
        .relative { position: relative; }
        .z-10 { z-index: 10; }
        .flex-1 { flex: 1; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .cursor-pointer { cursor: pointer; }
        .transition-colors { transition: color 0.3s ease; }
        .opacity-50 { opacity: 0.5; }

        .logo-accent { color: var(--accent); }

        .icon-arrow {
            font-size: 1.5rem;
            color: #cbd5e1;
        }

        .history-card {
            border-left: 4px solid #10b981;
            cursor: pointer;
        }

        .history-card:hover {
            background: #f0fdfa;
            border-left-color: #059669;
        }

        .history-meta {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .btn-icon {
            color: #cbd5e1;
            transition: color 0.3s ease;
            padding: 0.5rem;
            background: transparent;
        }

        .btn-icon:hover {
            color: var(--error);
        }

        .ordem-card {
            border-left: 4px solid var(--primary);
        }

        .dose-box {
            background: #f0fdfa;
            padding: 1rem;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #ccfbf1;
        }

        .dose-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #0f766e;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .dose-value {
            font-size: 2rem;
            font-weight: 800;
            color: #065f46;
            font-family: 'Space Mono', monospace;
        }

        .w-20 {
            width: 5rem;
            height: 5rem;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            background: #f0fdfa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .checkbox-container:hover {
            background: #ccfbf1;
        }

        .checkbox-container input[type="checkbox"] {
            width: 1.25rem;
            height: 1.25rem;
            cursor: pointer;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .stat-value { font-size: 2rem; }
            .card { padding: 1.5rem; }
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
            .menu-card { 
                flex-direction: row;
                text-align: left; 
            }
            .icon-arrow { display: none; }
            .toast { right: 1rem; left: 1rem; }
        }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav>
        <div class="nav-container">
            <h1 class="logo text-white" onclick="navTo('menu')">
                CALDA<span class="logo-accent">CERTA</span>
            </h1>
            <div id="user-display" class="user-badge mono">
                Modo Local
            </div>
        </div>
    </nav>

    <main class="container">
        
        <!-- MENU PRINCIPAL -->
        <section id="step-menu" class="step-content active">
            <div class="py-16 text-center">
                <div class="w-20 mx-auto mb-6" style="background: linear-gradient(135deg, #14b8a6, #0f766e); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 30px rgba(15, 118, 110, 0.3);">
                    <i class="fa-solid fa-droplet text-4xl text-white"></i>
                </div>
                <h2 class="text-4xl font-black text-slate-900 mb-2">Gest√£o de Caldas</h2>
                <p class="text-lg text-slate-600 font-semibold">Simula√ß√£o e Hist√≥rico Digital Profissional</p>
            </div>
            
            <div class="grid gap-6">
                <button onclick="startNewSimulation()" class="btn card menu-card relative z-10">
                    <div class="icon-box">
                        <i class="fa-solid fa-plus"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-black text-2xl text-slate-800 mb-1">Nova Simula√ß√£o</h3>
                        <p class="text-slate-600">Criar novo plano de mistura completo</p>
                    </div>
                    <i class="fa-solid fa-arrow-right icon-arrow"></i>
                </button>

                <button onclick="navTo('history')" class="btn card menu-card relative z-10">
                    <div class="icon-box icon-box-green">
                        <i class="fa-solid fa-clock-rotate-left"></i>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-black text-2xl text-slate-800 mb-1">Hist√≥rico</h3>
                        <p class="text-slate-600">Consultar simula√ß√µes salvas</p>
                    </div>
                    <i class="fa-solid fa-arrow-right icon-arrow"></i>
                </button>
            </div>
        </section>

        <!-- HIST√ìRICO -->
        <section id="step-history" class="step-content">
            <div class="section-header">
                <button onclick="navTo('menu')" class="btn btn-icon text-slate-500" style="padding: 0.5rem;">
                    <i class="fa-solid fa-arrow-left text-2xl"></i>
                </button>
                <h2 class="text-2xl font-black text-slate-800 flex-1">HIST√ìRICO DE SIMULA√á√ïES</h2>
            </div>

            <div class="search-box">
                <i class="fa-solid fa-search"></i>
                <input 
                    type="text" 
                    id="search-history" 
                    placeholder="Pesquisar por cliente, propriedade ou cultura..." 
                    class="input-box"
                    oninput="filterHistory()"
                >
            </div>

            <div id="history-list"></div>
            <div id="history-empty" class="empty-state hidden">
                <i class="fa-solid fa-folder-open"></i>
                <p class="text-xl font-bold">Nenhuma simula√ß√£o encontrada</p>
                <p class="mt-2">Crie sua primeira simula√ß√£o para come√ßar</p>
            </div>
        </section>

        <!-- ETAPA 2.1: IDENTIFICA√á√ÉO -->
        <section id="step-2-1" class="step-content">
            <div class="progress-bar">
                <div class="progress-fill" style="width: 16%;"></div>
            </div>

            <div class="section-header">
                <div class="section-number">1</div>
                <h2 class="text-2xl font-black text-slate-800 flex-1">IDENTIFICA√á√ÉO</h2>
            </div>

            <div class="card">
                <div class="mb-6">
                    <label class="label-text">Cliente *</label>
                    <input type="text" id="id_cliente" class="input-box" placeholder="Nome do cliente" list="clientes-list" required>
                    <datalist id="clientes-list"></datalist>
                </div>

                <div class="mb-6">
                    <label class="label-text">Propriedade *</label>
                    <input type="text" id="id_propriedade" class="input-box" placeholder="Nome da propriedade" list="propriedades-list" required>
                    <datalist id="propriedades-list"></datalist>
                </div>

                <div class="mb-6">
                    <label class="label-text">Talh√£o *</label>
                    <input type="text" id="id_talhao" class="input-box" placeholder="Identifica√ß√£o do talh√£o" list="talhoes-list" required>
                    <datalist id="talhoes-list"></datalist>
                </div>

                <div class="grid grid-2 mb-6">
                    <div>
                        <label class="label-text">√Årea (hectares) *</label>
                        <input type="number" id="id_area" class="input-box" placeholder="0" step="0.01" min="0" required>
                    </div>
                    <div>
                        <label class="label-text">Data da Aplica√ß√£o *</label>
                        <input type="date" id="id_data" class="input-box" required>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="label-text">Respons√°vel T√©cnico *</label>
                    <input type="text" id="id_responsavel" class="input-box" placeholder="Nome do respons√°vel t√©cnico" list="responsaveis-list" required>
                    <datalist id="responsaveis-list"></datalist>
                </div>

                <div class="grid grid-2 mb-6">
                    <div>
                        <label class="label-text">Cultura *</label>
                        <select id="id_cultura" class="input-box">
                            <option value="">Selecione...</option>
                            <option value="Soja">Soja</option>
                            <option value="Milho">Milho</option>
                            <option value="Algod√£o">Algod√£o</option>
                            <option value="Cana">Cana-de-a√ß√∫car</option>
                            <option value="Trigo">Trigo</option>
                            <option value="Arroz">Arroz</option>
                            <option value="Feij√£o">Feij√£o</option>
                            <option value="Caf√©">Caf√©</option>
                        </select>
                    </div>
                    <div>
                        <label class="label-text">Objetivo da Aplica√ß√£o *</label>
                        <select id="id_objetivo" class="input-box">
                            <option value="">Selecione...</option>
                            <option value="Controle de Pragas">Controle de Pragas</option>
                            <option value="Controle de Doen√ßas">Controle de Doen√ßas</option>
                            <option value="Controle de Plantas Daninhas">Controle de Plantas Daninhas</option>
                            <option value="Aduba√ß√£o Foliar">Aduba√ß√£o Foliar</option>
                            <option value="Desseca√ß√£o">Desseca√ß√£o</option>
                            <option value="Regulador de Crescimento">Regulador de Crescimento</option>
                        </select>
                    </div>
                </div>
            </div>
        </section>

        <!-- ETAPA 2.2: EQUIPAMENTO -->
        <section id="step-2-2" class="step-content">
            <div class="progress-bar">
                <div class="progress-fill" style="width: 32%;"></div>
            </div>

            <div class="section-header">
                <div class="section-number">2</div>
                <h2 class="text-2xl font-black text-slate-800 flex-1">EQUIPAMENTO E OPERADOR</h2>
            </div>

            <div class="card">
                <div class="mb-6">
                    <label class="label-text">Capacidade do Tanque (Litros) *</label>
                    <input type="number" id="eq_tanque" class="input-box" placeholder="2000" oninput="calcRendimento()" step="1" min="0" required>
                </div>

                <div class="mb-6">
                    <label class="label-text">Vaz√£o (L/ha) *</label>
                    <input type="number" id="eq_vazao" class="input-box" placeholder="200" oninput="calcRendimento()" step="1" min="0" required>
                </div>

                <div class="mb-8">
                    <label class="label-text">Operador da M√°quina *</label>
                    <input type="text" id="eq_operador" class="input-box" placeholder="Nome do operador" list="operadores-list" required>
                    <datalist id="operadores-list"></datalist>
                </div>

                <div class="stat-box">
                    <p class="stat-label">Rendimento por Tanque</p>
                    <h4 id="res_rendimento" class="stat-value">0.0</h4>
                    <p class="text-sm mt-2" style="opacity: 0.9;">hectares cobertos</p>
                </div>
            </div>
        </section>

        <!-- ETAPA 2.3: QUALIDADE DA √ÅGUA -->
        <section id="step-2-3" class="step-content">
            <div class="progress-bar">
                <div class="progress-fill" style="width: 48%;"></div>
            </div>

            <div class="section-header">
                <div class="section-number">3</div>
                <h2 class="text-2xl font-black text-slate-800 flex-1">QUALIDADE DA √ÅGUA</h2>
            </div>

            <div class="card">
                <div class="grid grid-3 mb-6">
                    <div>
                        <label class="label-text">pH da √Ågua</label>
                        <input type="number" id="agua_ph" class="input-box" placeholder="7.0" step="0.1" min="0" max="14">
                    </div>
                    <div>
                        <label class="label-text">Dureza (¬µS/cm)</label>
                        <input type="number" id="agua_dureza" class="input-box" placeholder="0" step="1" min="0">
                    </div>
                    <div>
                        <label class="label-text">Origem da √Ågua</label>
                        <select id="agua_origem" class="input-box">
                            <option value="Po√ßo">Po√ßo</option>
                            <option value="Rio">Rio</option>
                            <option value="Represa">Represa</option>
                            <option value="A√ßude">A√ßude</option>
                            <option value="Rede P√∫blica">Rede P√∫blica</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="label-text">Observa√ß√µes sobre a √Ågua</label>
                    <textarea id="agua_obs" class="input-box" rows="3" placeholder="Ex: √Ågua limpa, sem res√≠duos vis√≠veis"></textarea>
                </div>
            </div>
        </section>

        <!-- ETAPA 2.4: CLIMA -->
        <section id="step-2-4" class="step-content">
            <div class="progress-bar">
                <div class="progress-fill" style="width: 64%;"></div>
            </div>

            <div class="section-header">
                <div class="section-number">4</div>
                <h2 class="text-2xl font-black text-slate-800 flex-1">CONDI√á√ïES CLIM√ÅTICAS</h2>
            </div>

            <div class="card">
                <h3 class="font-bold text-lg mb-4 text-slate-700">
                    <i class="fa-solid fa-chart-line text-teal-600 mr-2"></i>
                    Delta T (Diferencial de Temperatura)
                </h3>
                <div class="chart-container">
                    <canvas id="chartDeltaT" height="200"></canvas>
                </div>

                <div id="alert-container" class="mb-6"></div>

                <h3 class="font-bold text-lg mb-4 text-slate-700">
                    <i class="fa-solid fa-temperature-high mr-2" style="color: #f59e0b;"></i>
                    Temperatura e Umidade
                </h3>
                <div class="chart-container">
                    <canvas id="chartClima" height="200"></canvas>
                </div>
            </div>
        </section>

        <!-- ETAPA 2.5: PRODUTOS -->
        <section id="step-2-5" class="step-content">
            <div class="progress-bar">
                <div class="progress-fill" style="width: 80%;"></div>
            </div>

            <div class="section-header">
                <div class="section-number">5</div>
                <h2 class="text-2xl font-black text-slate-800 flex-1">PRODUTOS</h2>
            </div>

            <div class="card">
                <div class="mb-4 flex items-center justify-between">
                    <h3 class="text-sm font-bold text-slate-700 uppercase">Adicionar Produto</h3>
                    <button onclick="toggleNovoOuBanco()" class="text-xs font-bold text-teal-600 hover:text-teal-800 transition-colors">
                        <i class="fa-solid fa-exchange-alt mr-1"></i>
                        <span id="toggle-text">Produto Novo</span>
                    </button>
                </div>

                <!-- Sele√ß√£o do Banco de Dados -->
                <div id="produto-banco" class="mb-6">
                    <label class="label-text">Buscar no Banco de Produtos</label>
                    <select id="p_banco" class="input-box" onchange="preencherDoBanco()">
                        <option value="">-- Selecione um produto --</option>
                    </select>
                    <p class="text-xs text-slate-500 mt-2">Selecione um produto e informe a dose abaixo</p>
                </div>

                <!-- Formul√°rio de Produto -->
                <div id="produto-form">
                    <div class="grid grid-2 mb-6">
                        <div>
                            <label class="label-text">Nome do Produto *</label>
                            <input type="text" id="p_nome" class="input-box" placeholder="Ex: Glifosato 480">
                        </div>
                        <div>
                            <label class="label-text">Marca Comercial</label>
                            <input type="text" id="p_marca" class="input-box" placeholder="Ex: Roundup">
                        </div>
                    </div>

                    <div class="grid grid-3 mb-6">
                        <div>
                            <label class="label-text">Formula√ß√£o *</label>
                            <select id="p_formulacao" class="input-box">
                                <option value="SC">SC - Suspens√£o Concentrada</option>
                                <option value="CE">CE - Concentrado Emulsion√°vel</option>
                                <option value="WG">WG - Granulado Dispers√≠vel</option>
                                <option value="EW">EW - Emuls√£o √Ågua/√ìleo</option>
                                <option value="OD">OD - Dispers√£o Oleosa</option>
                                <option value="ADJUVANTE">Adjuvante</option>
                                <option value="ESPALHANTE">Espalhante</option>
                                <option value="ANTIESPUMA">Anti-espuma</option>
                                <option value="FERTILIZANTE">Fertilizante</option>
                                <option value="OLEO">√ìleo</option>
                            </select>
                        </div>
                        <div>
                            <label class="label-text">Tipo de Produto</label>
                            <select id="p_tipo" class="input-box">
                                <option value="PRODUTO">Produto Fitossanit√°rio</option>
                                <option value="ADJUVANTE">Adjuvante/Espalhante/Anti-espuma</option>
                                <option value="FERTILIZANTE">Fertilizante</option>
                                <option value="OLEO">√ìleo Mineral/Vegetal</option>
                            </select>
                        </div>
                        <div>
                            <label class="label-text">pH da Calda</label>
                            <input type="number" id="p_ph" class="input-box" placeholder="Ex: 6.5" step="0.1" min="0" max="14">
                        </div>
                    </div>

                    <div class="mb-6">
                        <label class="label-text">Dose (L ou Kg/ha) *</label>
                        <input type="number" id="p_dose" class="input-box" placeholder="0.00" step="0.01" min="0">
                    </div>
                </div>

                <button onclick="addProduto()" class="btn btn-primary btn-full">
                    <i class="fa-solid fa-plus"></i>
                    Adicionar Produto √† Lista
                </button>
            </div>

            <div id="lista-produtos"></div>
            <div id="produtos-empty" class="empty-state hidden">
                <i class="fa-solid fa-box-open"></i>
                <p class="text-lg font-bold">Nenhum produto adicionado</p>
                <p class="mt-2">Adicione produtos para continuar</p>
            </div>
        </section>

        <!-- ETAPA 2.6: FINALIZA√á√ÉO -->
        <section id="step-2-6" class="step-content">
            <div class="progress-bar">
                <div class="progress-fill" style="width: 100%;"></div>
            </div>

            <div class="section-header">
                <div class="section-number">
                    <i class="fa-solid fa-check"></i>
                </div>
                <h2 class="text-2xl font-black text-slate-800 flex-1">ORDEM DE MISTURA</h2>
            </div>

            <div class="card card-compact mb-6">
                <label class="label-text">Volume da Jarra Teste</label>
                <select id="jarra_vol" class="input-box" style="margin-bottom: 0;" onchange="renderOrdem()">
                    <option value="500">500 ml</option>
                    <option value="1000" selected>1000 ml (1 Litro)</option>
                    <option value="1500">1500 ml (1,5 Litros)</option>
                    <option value="2000">2000 ml (2 Litros)</option>
                </select>
            </div>

            <div class="card card-compact mb-6">
                <div class="checkbox-container mb-4">
                    <input type="checkbox" id="respeitarHierarquia" checked onchange="toggleHierarchyOptions()">
                    <label for="respeitarHierarquia" class="font-bold text-sm" style="cursor: pointer;">
                        Respeitar hierarquia de mistura
                    </label>
                </div>
                
                <div id="hierarchyOptions" class="mt-4">
                    <label class="label-text">Crit√©rio de Ordena√ß√£o dos Produtos (2¬™ Ordem)</label>
                    <select id="criterioOrdenacao" class="input-box" style="margin-bottom: 0;" onchange="renderOrdem()">
                        <option value="tipo">Por Tipo de Solu√ß√£o (Padr√£o)</option>
                        <option value="ph-crescente">pH Crescente (Menor ‚Üí Maior)</option>
                        <option value="ph-decrescente">pH Decrescente (Maior ‚Üí Menor)</option>
                    </select>
                    <p class="text-xs text-slate-500 mt-2 ml-1">
                        <strong>Hierarquia:</strong> 1¬∞ Adjuvantes ‚Üí 2¬∞ Produtos (ordenados pelo crit√©rio) ‚Üí 3¬∞ Fertilizantes ‚Üí 4¬∞ √ìleos
                    </p>
                </div>
            </div>

            <h3 class="font-bold text-lg mb-4 text-slate-700">
                <i class="fa-solid fa-flask text-teal-600 mr-2"></i>
                Ordem de Mistura (Arraste para reordenar)
            </h3>
            <div class="ordem-scroll-container">
                <div id="ordem-container" class="ordem-inner mb-8"></div>
            </div>

            <div class="grid grid-2 mb-6">
                <button onclick="navTo('2-5')" class="btn btn-secondary">
                    <i class="fa-solid fa-arrow-left text-xl"></i>
                    <span class="font-bold">Voltar aos Produtos</span>
                </button>

                <button onclick="generatePDF()" class="btn btn-secondary">
                    <i class="fa-solid fa-file-pdf text-red-600 text-xl"></i>
                    <span class="font-bold">Gerar PDF</span>
                </button>
            </div>

            <button id="btn-save-cloud" onclick="saveSimulation()" class="btn btn-primary btn-full mb-6">
                <i class="fa-solid fa-save text-xl"></i>
                Salvar Simula√ß√£o Completa
            </button>

            <button onclick="navTo('menu')" class="btn btn-full py-4 text-slate-500 font-bold uppercase text-sm transition-colors" style="background: transparent; border: none;">
                <i class="fa-solid fa-home mr-2"></i>
                Voltar ao Menu Principal
            </button>
        </section>

    </main>

    <!-- Navega√ß√£o Inferior -->
    <footer id="app-nav" class="hidden">
        <div class="footer-container">
            <button id="btn-prev" onclick="handlePrev()" class="btn btn-secondary">
                <i class="fa-solid fa-chevron-left mr-2"></i>
                Anterior
            </button>
            <button id="btn-next" onclick="handleNext()" class="btn btn-primary">
                Pr√≥ximo
                <i class="fa-solid fa-chevron-right"></i>
            </button>
        </div>
    </footer>

    <script>
        // VERS√ÉO COM API - BACKEND NODE.JS + SQLITE
        // A configura√ß√£o da API est√° em api-config.js
        
        let products = [];
        let historicalData = [];
        let currentStepIdx = 0;
        const steps = ['menu', '2-1', '2-2', '2-3', '2-4', '2-5', '2-6'];
        let sortableInstance = null;

        // Bancos de dados (carregados da API)
        let bancoProdutos = [];
        let bancoClientes = [];
        let bancoPropriedades = [];
        let bancoTalhoes = [];
        let bancoResponsaveis = [];
        let bancoOperadores = [];

        // Inicializar bancos de dados da API
        async function initBancosDados() {
            try {
                // Mostrar indicador de carregamento
                console.log('üì° Carregando dados da API...');
                
                // Carregar produtos do servidor
                bancoProdutos = await API.getProdutos();
                console.log(`‚úÖ ${bancoProdutos.length} produtos carregados`);
                
                // Carregar dados de identifica√ß√£o
                const clientes = await API.getClientes();
                const responsaveis = await API.getResponsaveis();
                const operadores = await API.getOperadores();
                
                bancoClientes = clientes.map(c => c.nome);
                bancoResponsaveis = responsaveis.map(r => r.nome);
                bancoOperadores = operadores.map(o => o.nome);
                
                console.log(`‚úÖ ${bancoClientes.length} clientes, ${bancoResponsaveis.length} respons√°veis, ${bancoOperadores.length} operadores`);
                
                // Preencher datalists
                preencherDatalist('clientes-list', bancoClientes);
                preencherDatalist('propriedades-list', bancoPropriedades);
                preencherDatalist('talhoes-list', bancoTalhoes);
                preencherDatalist('responsaveis-list', bancoResponsaveis);
                preencherDatalist('operadores-list', bancoOperadores);

                // Preencher select de produtos
                preencherSelectProdutos();
                
                console.log('‚úÖ Bancos de dados carregados com sucesso!');
            } catch (error) {
                console.error('‚ùå Erro ao carregar dados da API:', error);
                showToast('‚ö†Ô∏è Erro ao conectar com servidor. Verifique se est√° rodando.', 'error');
            }
        }

        function preencherDatalist(elementId, dados) {
            const datalist = document.getElementById(elementId);
            datalist.innerHTML = dados.map(item => `<option value="${item}">`).join('');
        }

        function preencherSelectProdutos() {
            const select = document.getElementById('p_banco');
            select.innerHTML = '<option value="">-- Selecione um produto --</option>' +
                bancoProdutos.map((p, idx) => `<option value="${idx}">${p.nome} (${p.marca})</option>`).join('');
        }

        // Toggle entre banco e manual
        let usandoBanco = true;
        window.toggleNovoOuBanco = () => {
            usandoBanco = !usandoBanco;
            const bancDiv = document.getElementById('produto-banco');
            const toggleText = document.getElementById('toggle-text');
            const camposReadonly = ['p_nome', 'p_marca', 'p_formulacao', 'p_tipo'];
            
            if (usandoBanco) {
                // Modo Banco: mostra select, bloqueia campos de produto
                bancDiv.style.display = 'block';
                toggleText.innerText = 'Produto Novo';
                
                // Limpar sele√ß√£o
                document.getElementById('p_banco').selectedIndex = 0;
                limparCamposProduto();
            } else {
                // Modo Manual: esconde select, libera todos campos
                bancDiv.style.display = 'none';
                toggleText.innerText = 'Buscar no Banco';
                
                // Habilitar todos os campos
                camposReadonly.forEach(id => {
                    document.getElementById(id).disabled = false;
                });
                
                limparCamposProduto();
                document.getElementById('p_nome').focus();
            }
        };

        function limparCamposProduto() {
            document.getElementById('p_nome').value = '';
            document.getElementById('p_marca').value = '';
            document.getElementById('p_dose').value = '';
            document.getElementById('p_ph').value = '';
            document.getElementById('p_formulacao').selectedIndex = 0;
            document.getElementById('p_tipo').selectedIndex = 0;
        }

        // Preencher do banco
        window.preencherDoBanco = () => {
            const selectIdx = document.getElementById('p_banco').value;
            if (selectIdx === '') {
                limparCamposProduto();
                return;
            }
            
            const produto = bancoProdutos[parseInt(selectIdx)];
            
            // Preencher campos
            document.getElementById('p_nome').value = produto.nome;
            document.getElementById('p_marca').value = produto.marca;
            document.getElementById('p_formulacao').value = produto.formulacao;
            document.getElementById('p_tipo').value = produto.tipo;
            document.getElementById('p_ph').value = produto.ph || '';
            
            // Limpar dose para usu√°rio preencher
            document.getElementById('p_dose').value = '';
            
            // Focar no campo dose
            setTimeout(() => {
                document.getElementById('p_dose').focus();
            }, 100);
        };

        // Carregar hist√≥rico do servidor
        async function loadHistory() {
            try {
                historicalData = await API.getSimulacoes();
                renderHistoryList(historicalData);
            } catch (e) {
                console.error('Erro ao carregar hist√≥rico:', e);
                historicalData = [];
                showToast('‚ö†Ô∏è Erro ao carregar hist√≥rico', 'error');
            }
        }

        // Fun√ß√£o para organizar produtos por hierarquia
        function sortProductsByHierarchy(products, criterio = 'tipo') {
            const hierarchy = {
                'ADJUVANTE': 1,
                'ESPALHANTE': 1,
                'ANTIESPUMA': 1,
                'PRODUTO': 2,
                'SC': 2,
                'CE': 2,
                'WG': 2,
                'EW': 2,
                'OD': 2,
                'FERTILIZANTE': 3,
                'OLEO': 4
            };

            return [...products].sort((a, b) => {
                const prioA = hierarchy[a.tipo] || hierarchy[a.formulacao] || 2;
                const prioB = hierarchy[b.tipo] || hierarchy[b.formulacao] || 2;
                
                // Se t√™m prioridades diferentes, ordena por prioridade
                if (prioA !== prioB) {
                    return prioA - prioB;
                }
                
                // Se ambos s√£o produtos (prioridade 2), aplica o crit√©rio de ordena√ß√£o
                if (prioA === 2 && prioB === 2) {
                    if (criterio === 'ph-crescente') {
                        // pH crescente (menor para maior)
                        const phA = a.ph || 7; // default 7 se n√£o informado
                        const phB = b.ph || 7;
                        return phA - phB;
                    } else if (criterio === 'ph-decrescente') {
                        // pH decrescente (maior para menor)
                        const phA = a.ph || 7;
                        const phB = b.ph || 7;
                        return phB - phA;
                    } else {
                        // Por tipo de solu√ß√£o (formula√ß√£o)
                        return a.formulacao.localeCompare(b.formulacao);
                    }
                }
                
                // Mant√©m ordem original dentro da mesma prioridade
                return 0;
            });
        }
        
        // Fun√ß√£o para mostrar/ocultar op√ß√µes de hierarquia
        window.toggleHierarchyOptions = () => {
            const checked = document.getElementById('respeitarHierarquia').checked;
            const options = document.getElementById('hierarchyOptions');
            if (checked) {
                options.style.display = 'block';
            } else {
                options.style.display = 'none';
            }
            renderOrdem();
        };

        // Salvar simula√ß√£o na API
        window.saveSimulation = async () => {
            if (!document.getElementById('id_cliente').value) {
                showToast('‚ùå Preencha o nome do cliente', 'error');
                return;
            }

            if (products.length === 0) {
                showToast('‚ùå Adicione pelo menos um produto', 'error');
                return;
            }

            const btn = document.getElementById('btn-save-cloud');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Salvando...';

            const payload = {
                cliente: document.getElementById('id_cliente').value,
                propriedade: document.getElementById('id_propriedade').value,
                talhao: document.getElementById('id_talhao').value,
                cultura: document.getElementById('id_cultura').value,
                data_aplicacao: document.getElementById('id_data').value,
                area: parseFloat(document.getElementById('id_area').value) || 0,
                responsavel: document.getElementById('id_responsavel').value,
                objetivo: document.getElementById('id_objetivo').value,
                tanque_capacidade: parseFloat(document.getElementById('eq_tanque').value) || 0,
                vazao: parseFloat(document.getElementById('eq_vazao').value) || 0,
                operador: document.getElementById('eq_operador').value,
                rendimento: parseFloat(document.getElementById('res_rendimento').innerText) || 0,
                agua_ph: parseFloat(document.getElementById('agua_ph').value) || null,
                agua_dureza: parseFloat(document.getElementById('agua_dureza').value) || null,
                agua_origem: document.getElementById('agua_origem').value,
                agua_observacoes: document.getElementById('agua_obs').value,
                jarra_volume: parseInt(document.getElementById('jarra_vol').value),
                respeitar_hierarquia: document.getElementById('respeitarHierarquia').checked ? 1 : 0,
                criterio_ordenacao: document.getElementById('criterioOrdenacao').value,
                produtos: products
            };

            try {
                const result = await API.saveSimulacao(payload);
                showToast('‚úÖ Simula√ß√£o salva no servidor!', 'success');
                btn.innerHTML = '<i class="fa-solid fa-check"></i> Salvo no Servidor';
                btn.classList.add('opacity-50');
                
                await loadHistory();
                await initBancosDados(); // Recarregar autocompletes
            } catch (e) {
                console.error('Erro ao salvar:', e);
                showToast('‚ùå Erro ao salvar no servidor', 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-save text-xl"></i> Salvar Simula√ß√£o Completa';
            }
        };

        function renderHistoryList(data) {
            const list = document.getElementById('history-list');
            const empty = document.getElementById('history-empty');
            
            if (data.length === 0) {
                list.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }
            
            empty.classList.add('hidden');
            list.innerHTML = data.map(item => {
                const date = item.data_aplicacao ? new Date(item.data_aplicacao).toLocaleDateString('pt-BR') : 'Data n√£o informada';
                const prodCount = item.produtos_nomes ? item.produtos_nomes.split('|').length : 0;
                
                return `
                    <div class="card card-medium history-card" onclick="viewSimulation(${item.id})">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-black text-xl text-slate-800 mb-1">${item.cliente}</h4>
                                <p class="text-sm text-slate-600">${item.propriedade} - ${item.talhao}</p>
                            </div>
                            <span class="badge badge-primary">${item.cultura}</span>
                        </div>
                        <div class="history-meta text-sm text-slate-500">
                            <span><i class="fa-solid fa-calendar mr-1"></i>${date}</span>
                            <span><i class="fa-solid fa-map-marked-alt mr-1"></i>${item.area} ha</span>
                            <span><i class="fa-solid fa-box mr-1"></i>${prodCount} produto${prodCount !== 1 ? 's' : ''}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.filterHistory = () => {
            const query = document.getElementById('search-history').value.toLowerCase();
            const filtered = historicalData.filter(item => {
                const cliente = (item.cliente || '').toLowerCase();
                const propriedade = (item.propriedade || '').toLowerCase();
                const cultura = (item.cultura || '').toLowerCase();
                const talhao = (item.talhao || '').toLowerCase();
                return cliente.includes(query) || propriedade.includes(query) || cultura.includes(query) || talhao.includes(query);
            });
            renderHistoryList(filtered);
        };

        window.viewSimulation = async (id) => {
            try {
                const item = await API.getSimulacao(id);
                if (!item) return;
                
                document.getElementById('id_cliente').value = item.cliente;
                document.getElementById('id_propriedade').value = item.propriedade;
                document.getElementById('id_talhao').value = item.talhao || '';
                document.getElementById('id_area').value = item.area;
                document.getElementById('id_data').value = item.data_aplicacao;
                document.getElementById('id_cultura').value = item.cultura;
                document.getElementById('id_responsavel').value = item.responsavel || '';
                document.getElementById('id_objetivo').value = item.objetivo || '';
                document.getElementById('eq_tanque').value = item.tanque_capacidade;
                document.getElementById('eq_vazao').value = item.vazao;
                document.getElementById('eq_operador').value = item.operador || '';
                document.getElementById('jarra_vol').value = item.jarra_volume || 1000;
                document.getElementById('respeitarHierarquia').checked = item.respeitar_hierarquia;
                document.getElementById('criterioOrdenacao').value = item.criterio_ordenacao || 'tipo';
                
                document.getElementById('agua_ph').value = item.agua_ph || '';
                document.getElementById('agua_dureza').value = item.agua_dureza || '';
                document.getElementById('agua_origem').value = item.agua_origem || 'Po√ßo';
                document.getElementById('agua_obs').value = item.agua_observacoes || '';
                
                products = item.produtos.map(p => ({
                    id: p.id || Date.now() + Math.random(),
                    nome: p.produto_nome,
                    marca: p.produto_marca,
                    dose: p.dose,
                    formulacao: p.formulacao,
                    tipo: p.tipo,
                    ph: p.ph
                }));
                
                renderProductList();
                calcRendimento();
                toggleHierarchyOptions();
                navTo('2-6');
            } catch (e) {
                console.error('Erro ao carregar simula√ß√£o:', e);
                showToast('‚ùå Erro ao carregar simula√ß√£o', 'error');
            }
        };

        // Navega√ß√£o
        window.navTo = (id) => {
            currentStepIdx = steps.indexOf(id.replace('step-',''));
            
            document.querySelectorAll('.step-content').forEach(s => s.classList.remove('active'));
            const target = id === 'history' ? 'step-history' : `step-${steps[currentStepIdx]}`;
            document.getElementById(target).classList.add('active');

            const footer = document.getElementById('app-nav');
            const isMenu = id === 'menu' || id === 'history';
            const isLast = steps[currentStepIdx] === '2-6';
            
            footer.classList.toggle('hidden', isMenu || isLast);
            document.getElementById('btn-prev').classList.toggle('hidden', currentStepIdx <= 1);
            
            if (steps[currentStepIdx] === '2-4') {
                initCharts();
                checkClimateConditions();
            }
            if (steps[currentStepIdx] === '2-6') {
                const btnSave = document.getElementById('btn-save-cloud');
                btnSave.disabled = false;
                btnSave.innerHTML = '<i class="fa-solid fa-save text-xl"></i> Salvar Simula√ß√£o';
                btnSave.classList.remove('opacity-50');
                renderOrdem();
            }
            
            window.scrollTo({top: 0, behavior: 'smooth'});
        };

        window.handleNext = () => {
            if (currentStepIdx === 1) {
                const cliente = document.getElementById('id_cliente').value;
                if (!cliente) {
                    showToast('‚ùå Preencha o nome do cliente', 'error');
                    return;
                }
            }
            
            if (currentStepIdx === 2) {
                const tanque = document.getElementById('eq_tanque').value;
                const vazao = document.getElementById('eq_vazao').value;
                if (!tanque || !vazao) {
                    showToast('‚ùå Preencha os dados do equipamento', 'error');
                    return;
                }
            }
            
            if (currentStepIdx === 5) {
                if (products.length === 0) {
                    showToast('‚ùå Adicione pelo menos um produto', 'error');
                    return;
                }
            }
            
            if (currentStepIdx < steps.length - 1) navTo(steps[currentStepIdx + 1]);
        };

        window.handlePrev = () => {
            if (currentStepIdx > 1) navTo(steps[currentStepIdx - 1]);
        };

        window.startNewSimulation = () => {
            products = [];
            renderProductList();
            document.querySelectorAll('input').forEach(i => {
                if (i.type !== 'date' && i.type !== 'checkbox') i.value = "";
            });
            document.querySelectorAll('textarea').forEach(t => t.value = "");
            document.getElementById('id_data').value = new Date().toISOString().split('T')[0];
            document.getElementById('id_cultura').selectedIndex = 0;
            document.getElementById('id_objetivo').selectedIndex = 0;
            document.getElementById('res_rendimento').innerText = "0.0";
            document.getElementById('respeitarHierarquia').checked = true;
            navTo('2-1');
        };

        // Produtos
        window.addProduto = async () => {
            const nome = document.getElementById('p_nome').value;
            const dose = parseFloat(document.getElementById('p_dose').value);
            const formulacao = document.getElementById('p_formulacao').value;
            const marca = document.getElementById('p_marca').value;
            const tipo = document.getElementById('p_tipo').value;
            const ph = parseFloat(document.getElementById('p_ph').value) || null;
            
            if (!nome || !dose) {
                showToast('‚ùå Preencha nome e dose do produto', 'error');
                return;
            }
            
            const p = {
                id: Date.now(),
                nome: nome,
                marca: marca || 'N√£o informada',
                dose: dose,
                formulacao: formulacao,
                tipo: tipo,
                ph: ph
            };
            
            products.push(p);
            renderProductList();
            
            // Se √© produto novo (n√£o do banco), adicionar ao banco via API
            if (!usandoBanco && !bancoProdutos.find(bp => bp.nome === nome && bp.marca === marca)) {
                try {
                    await API.saveProduto({
                        nome: nome,
                        marca: marca,
                        formulacao: formulacao,
                        tipo: tipo,
                        ph: ph
                    });
                    await initBancosDados(); // Recarregar produtos
                    showToast('üíæ Produto adicionado ao banco de dados', 'success');
                } catch (e) {
                    console.error('Erro ao salvar produto:', e);
                }
            }
            
            document.getElementById('p_nome').value = "";
            document.getElementById('p_marca').value = "";
            document.getElementById('p_dose').value = "";
            document.getElementById('p_ph').value = "";
            document.getElementById('p_formulacao').selectedIndex = 0;
            document.getElementById('p_tipo').selectedIndex = 0;
            document.getElementById('p_banco').selectedIndex = 0;
            
            showToast('‚úÖ Produto adicionado √† lista', 'success');
        };

        function renderProductList() {
            const lista = document.getElementById('lista-produtos');
            const empty = document.getElementById('produtos-empty');
            
            if (products.length === 0) {
                lista.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }
            
            empty.classList.add('hidden');
            lista.innerHTML = products.map((p, idx) => `
                <div class="product-item">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="badge badge-accent">${idx + 1}</span>
                            <h4 class="font-bold text-slate-800">${p.nome}</h4>
                            <span class="badge badge-primary text-xs">${p.formulacao}</span>
                        </div>
                        <p class="text-sm text-slate-600">
                            ${p.marca} ¬∑ <span class="font-semibold">${p.dose}</span> L-Kg/ha
                        </p>
                    </div>
                    <button onclick="removeProduct(${p.id})" class="btn btn-icon">
                        <i class="fa-solid fa-trash text-lg"></i>
                    </button>
                </div>
            `).join('');
        }

        window.removeProduct = (id) => {
            products = products.filter(p => p.id !== id);
            renderProductList();
            showToast('üóëÔ∏è Produto removido', 'success');
        };

        // C√°lculos
        window.calcRendimento = () => {
            const tanque = parseFloat(document.getElementById('eq_tanque').value) || 0;
            const vazao = parseFloat(document.getElementById('eq_vazao').value) || 0;
            const rendimento = vazao > 0 ? (tanque / vazao).toFixed(2) : "0.0";
            document.getElementById('res_rendimento').innerText = rendimento;
        };

        window.renderOrdem = () => {
            const jarra = parseFloat(document.getElementById('jarra_vol').value);
            const vazao = parseFloat(document.getElementById('eq_vazao').value) || 100;
            const tanque = parseFloat(document.getElementById('eq_tanque').value) || 2000;
            const area = parseFloat(document.getElementById('id_area').value) || 10;
            const container = document.getElementById('ordem-container');
            const respeitar = document.getElementById('respeitarHierarquia').checked;
            const criterio = document.getElementById('criterioOrdenacao').value;
            
            if (products.length === 0) {
                container.innerHTML = '<div class="empty-state"><p class="text-slate-500">Nenhum produto adicionado</p></div>';
                return;
            }
            
            let displayProducts = respeitar ? sortProductsByHierarchy(products, criterio) : products;
            
            container.innerHTML = displayProducts.map((p, i) => {
                const doseJarra = ((p.dose * jarra) / vazao).toFixed(2);
                const doseTanque = ((p.dose * tanque) / vazao).toFixed(2);
                const volumeTotal = (p.dose * area).toFixed(2);
                const phDisplay = p.ph ? `pH: ${p.ph}` : '';
                
                return `
                    <div class="product-item ordem-card" data-id="${p.id}">
                        <i class="fa-solid fa-grip-vertical drag-handle"></i>
                        <div class="flex-1">
                            <div class="flex justify-between items-center mb-3">
                                <div class="flex items-center gap-3">
                                    <span class="badge badge-primary">Ordem ${i+1}</span>
                                    <span class="badge badge-accent">${p.formulacao}</span>
                                    ${phDisplay ? `<span class="badge badge-success">${phDisplay}</span>` : ''}
                                </div>
                            </div>
                            <h4 class="text-lg font-black text-slate-800 mb-1">${p.nome}</h4>
                            <p class="text-sm text-slate-600 mb-3">${p.marca}</p>
                            <div class="grid grid-3 gap-2">
                                <div class="dose-box" style="padding: 0.5rem;">
                                    <p class="dose-label" style="font-size: 0.65rem;">Jarra (${jarra}ml)</p>
                                    <p class="dose-value" style="font-size: 1.25rem;">${doseJarra} ml</p>
                                </div>
                                <div class="dose-box" style="padding: 0.5rem;">
                                    <p class="dose-label" style="font-size: 0.65rem;">Tanque</p>
                                    <p class="dose-value" style="font-size: 1.25rem;">${doseTanque} ${p.dose < 1 ? 'ml' : 'L'}</p>
                                </div>
                                <div class="dose-box" style="padding: 0.5rem;">
                                    <p class="dose-label" style="font-size: 0.65rem;">Total (${area} ha)</p>
                                    <p class="dose-value" style="font-size: 1.25rem;">${volumeTotal} ${p.dose < 1 ? 'ml' : 'L'}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Inicializar Sortable.js para drag and drop
            if (sortableInstance) {
                sortableInstance.destroy();
            }
            
            if (!respeitar) {
                sortableInstance = new Sortable(container, {
                    animation: 150,
                    handle: '.drag-handle',
                    ghostClass: 'sortable-ghost',
                    dragClass: 'sortable-drag',
                    onEnd: function(evt) {
                        const itemEl = evt.item;
                        const newIndex = evt.newIndex;
                        const oldIndex = evt.oldIndex;
                        
                        // Reordenar array de produtos
                        const movedItem = products.splice(oldIndex, 1)[0];
                        products.splice(newIndex, 0, movedItem);
                        
                        showToast('üì¶ Ordem atualizada', 'success');
                    }
                });
            }
        };

        // Verifica√ß√£o de condi√ß√µes clim√°ticas
        function checkClimateConditions() {
            const alertContainer = document.getElementById('alert-container');
            const deltaT = [2, 3, 5, 8, 12, 14, 15, 12, 8, 4, 2, 1];
            const maxDelta = Math.max(...deltaT);
            const minDelta = Math.min(...deltaT);
            
            let alertHTML = '';
            
            if (maxDelta > 10) {
                alertHTML += `
                    <div class="alert alert-danger">
                        <i class="fa-solid fa-triangle-exclamation alert-icon"></i>
                        <div>
                            <h4 class="font-bold mb-1">‚ö†Ô∏è CONDI√á√ÉO CR√çTICA PARA APLICA√á√ÉO</h4>
                            <p>Delta T acima de 10¬∞C detectado (m√°x: ${maxDelta}¬∞C). <strong>N√£o recomendado aplicar!</strong> Alto risco de deriva e evapora√ß√£o.</p>
                        </div>
                    </div>
                `;
            } else if (maxDelta > 8) {
                alertHTML += `
                    <div class="alert alert-warning">
                        <i class="fa-solid fa-exclamation-circle alert-icon"></i>
                        <div>
                            <h4 class="font-bold mb-1">‚ö†Ô∏è ATEN√á√ÉO: Condi√ß√£o Marginal</h4>
                            <p>Delta T entre 8-10¬∞C (m√°x: ${maxDelta}¬∞C). Aplica√ß√£o com cautela. Monitorar ventos e umidade.</p>
                        </div>
                    </div>
                `;
            } else if (minDelta < 2) {
                alertHTML += `
                    <div class="alert alert-warning">
                        <i class="fa-solid fa-exclamation-circle alert-icon"></i>
                        <div>
                            <h4 class="font-bold mb-1">‚ö†Ô∏è ATEN√á√ÉO: Delta T Muito Baixo</h4>
                            <p>Delta T abaixo de 2¬∞C (m√≠n: ${minDelta}¬∞C). Risco de invers√£o t√©rmica. Evitar aplica√ß√£o.</p>
                        </div>
                    </div>
                `;
            } else {
                alertHTML += `
                    <div class="alert alert-success">
                        <i class="fa-solid fa-circle-check alert-icon"></i>
                        <div>
                            <h4 class="font-bold mb-1">‚úÖ CONDI√á√ÉO IDEAL PARA APLICA√á√ÉO</h4>
                            <p>Delta T entre 2-8¬∞C. Condi√ß√µes favor√°veis para pulveriza√ß√£o com baixo risco de deriva.</p>
                        </div>
                    </div>
                `;
            }
            
            alertContainer.innerHTML = alertHTML;
        }

        // PDF MELHORADO
        window.generatePDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');
            
            // P√ÅGINA 1 - CABE√áALHO E ORDEM DE MISTURA (PAISAGEM)
            
            // Cabe√ßalho
            doc.setFillColor(15, 118, 110);
            doc.rect(0, 0, 297, 35, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.setFont(undefined, 'bold');
            doc.text('CALDACERTA - PLANO DE APLICA√á√ÉO', 148.5, 15, { align: 'center' });
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 148.5, 23, { align: 'center' });
            
            // Dados de Identifica√ß√£o
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            
            let y = 45;
            const col1 = 15;
            const col2 = 105;
            const col3 = 195;
            
            // Coluna 1
            doc.text('CLIENTE:', col1, y);
            doc.setFont(undefined, 'normal');
            doc.text(document.getElementById('id_cliente').value, col1 + 20, y);
            
            y += 7;
            doc.setFont(undefined, 'bold');
            doc.text('PROPRIEDADE:', col1, y);
            doc.setFont(undefined, 'normal');
            doc.text(document.getElementById('id_propriedade').value, col1 + 30, y);
            
            y += 7;
            doc.setFont(undefined, 'bold');
            doc.text('TALH√ÉO:', col1, y);
            doc.setFont(undefined, 'normal');
            doc.text(document.getElementById('id_talhao').value, col1 + 20, y);
            
            // Coluna 2
            y = 45;
            doc.setFont(undefined, 'bold');
            doc.text('DATA APLICA√á√ÉO:', col2, y);
            doc.setFont(undefined, 'normal');
            const dataAplicacao = new Date(document.getElementById('id_data').value).toLocaleDateString('pt-BR');
            doc.text(dataAplicacao, col2 + 35, y);
            
            y += 7;
            doc.setFont(undefined, 'bold');
            doc.text('CULTURA:', col2, y);
            doc.setFont(undefined, 'normal');
            doc.text(document.getElementById('id_cultura').value, col2 + 20, y);
            
            y += 7;
            doc.setFont(undefined, 'bold');
            doc.text('√ÅREA:', col2, y);
            doc.setFont(undefined, 'normal');
            doc.text(`${document.getElementById('id_area').value} ha`, col2 + 15, y);
            
            // Coluna 3
            y = 45;
            doc.setFont(undefined, 'bold');
            doc.text('RESP. T√âCNICO:', col3, y);
            doc.setFont(undefined, 'normal');
            doc.text(document.getElementById('id_responsavel').value, col3 + 35, y);
            
            y += 7;
            doc.setFont(undefined, 'bold');
            doc.text('OPERADOR:', col3, y);
            doc.setFont(undefined, 'normal');
            doc.text(document.getElementById('eq_operador').value, col3 + 25, y);
            
            y += 7;
            doc.setFont(undefined, 'bold');
            doc.text('OBJETIVO:', col3, y);
            doc.setFont(undefined, 'normal');
            doc.text(document.getElementById('id_objetivo').value, col3 + 23, y);
            
            // Dados da M√°quina
            y += 12;
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('DADOS DA M√ÅQUINA', col1, y);
            
            y += 7;
            doc.setFontSize(9);
            doc.text(`Capacidade: ${document.getElementById('eq_tanque').value} L  |  Vaz√£o: ${document.getElementById('eq_vazao').value} L/ha  |  Rendimento: ${document.getElementById('res_rendimento').innerText} ha/tanque`, col1, y);
            
            // Tabela de Ordem de Mistura
            y += 10;
            const jarra = parseFloat(document.getElementById('jarra_vol').value);
            const vazao = parseFloat(document.getElementById('eq_vazao').value) || 100;
            const tanque = parseFloat(document.getElementById('eq_tanque').value) || 2000;
            const area = parseFloat(document.getElementById('id_area').value) || 10;
            const respeitar = document.getElementById('respeitarHierarquia').checked;
            const criterio = document.getElementById('criterioOrdenacao').value;
            
            let displayProducts = respeitar ? sortProductsByHierarchy(products, criterio) : products;
            
            const tableData = displayProducts.map((p, i) => [
                `${i + 1}`,
                p.nome,
                p.marca,
                p.ph ? `pH ${p.ph}` : '-',
                `${p.dose}`,
                `${((p.dose * jarra) / vazao).toFixed(2)}`,
                `${(p.dose * area).toFixed(1)}`,
                `${((p.dose * tanque) / vazao).toFixed(1)}`
            ]);
            
            doc.autoTable({
                startY: y,
                head: [['#', 'Produto', 'Marca', 'pH', 'Dose/ha', `Jarra\n(${jarra}ml)`, `TOTAL\n(${area}ha)`, 'DOSE\nTANQUE']],
                body: tableData,
                theme: 'grid',
                headStyles: { 
                    fillColor: [15, 118, 110],
                    fontSize: 8,
                    fontStyle: 'bold',
                    halign: 'center',
                    valign: 'middle'
                },
                bodyStyles: {
                    fontSize: 7,
                    valign: 'middle'
                },
                columnStyles: {
                    0: { cellWidth: 10, halign: 'center' },
                    1: { cellWidth: 65 },
                    2: { cellWidth: 45 },
                    3: { cellWidth: 18, halign: 'center' },
                    4: { cellWidth: 22, halign: 'center' },
                    5: { cellWidth: 22, halign: 'center' },
                    6: { 
                        cellWidth: 28, 
                        halign: 'center',
                        fillColor: [255, 237, 213], // Laranja claro
                        textColor: [0, 0, 0],
                        fontStyle: 'bold',
                        fontSize: 9
                    },
                    7: { 
                        cellWidth: 30, 
                        halign: 'center',
                        fillColor: [254, 243, 199], // Amarelo claro
                        textColor: [0, 0, 0],
                        fontStyle: 'bold',
                        fontSize: 9
                    }
                },
                margin: { left: 15, right: 15 },
                didDrawCell: function(data) {
                    // Adicionar borda extra nas colunas importantes
                    if (data.column.index === 6 || data.column.index === 7) {
                        doc.setDrawColor(234, 88, 12); // Cor laranja para destaque
                        doc.setLineWidth(0.5);
                        doc.rect(data.cell.x, data.cell.y, data.cell.width, data.cell.height);
                    }
                }
            });
            
            // P√ÅGINA 2 - QUALIDADE DA √ÅGUA E GR√ÅFICOS (PAISAGEM)
            doc.addPage('landscape');
            
            // Cabe√ßalho P√°gina 2
            doc.setFillColor(15, 118, 110);
            doc.rect(0, 0, 297, 25, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('QUALIDADE DA √ÅGUA E CONDI√á√ïES CLIM√ÅTICAS', 148.5, 15, { align: 'center' });
            
            // Qualidade da √Ågua
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('1. QUALIDADE DA √ÅGUA', 15, 35);
            
            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            y = 43;
            
            const ph = document.getElementById('agua_ph').value || 'N√£o informado';
            const dureza = document.getElementById('agua_dureza').value || 'N√£o informado';
            const origem = document.getElementById('agua_origem').value;
            const obs = document.getElementById('agua_obs').value || 'Sem observa√ß√µes';
            
            doc.text(`pH: ${ph}`, 15, y);
            doc.text(`Dureza: ${dureza} ¬µS/cm`, 70, y);
            doc.text(`Origem: ${origem}`, 140, y);
            y += 6;
            doc.text(`Observa√ß√µes: ${obs}`, 15, y);
            
            // Gr√°ficos lado a lado
            y += 15;
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            
            // Delta T √† esquerda
            doc.text('2. GR√ÅFICO DELTA T', 15, y);
            const chartDeltaT = document.getElementById('chartDeltaT');
            if (chartDeltaT) {
                const imgDeltaT = chartDeltaT.toDataURL('image/png');
                doc.addImage(imgDeltaT, 'PNG', 15, y + 5, 130, 110);
            }
            
            // Condi√ß√µes Meteorol√≥gicas √† direita
            doc.text('3. CONDI√á√ïES METEOROL√ìGICAS', 155, y);
            const chartClima = document.getElementById('chartClima');
            if (chartClima) {
                const imgClima = chartClima.toDataURL('image/png');
                doc.addImage(imgClima, 'PNG', 155, y + 5, 130, 110);
            }
            
            // Salvar
            doc.save(`CaldaCerta_${document.getElementById('id_cliente').value}_${new Date().toISOString().split('T')[0]}.pdf`);
            showToast('‚úÖ PDF completo gerado com sucesso!', 'success');
        };

        // Gr√°ficos
        let charts = [];
        function initCharts() {
            charts.forEach(c => c.destroy());
            charts = [];
            
            const hours = Array.from({length: 12}, (_, i) => `${i+6}h`);
            
            const chartDeltaT = new Chart(document.getElementById('chartDeltaT'), {
                type: 'line',
                data: {
                    labels: hours,
                    datasets: [{
                        label: 'Delta T (¬∞C)',
                        data: [2, 3, 5, 8, 12, 14, 15, 12, 8, 4, 2, 1],
                        borderColor: '#14b8a6',
                        backgroundColor: 'rgba(20, 184, 166, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 5,
                        pointBackgroundColor: '#14b8a6',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: { 
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            padding: 12,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#f5f5f4' },
                            title: { display: true, text: 'Delta T (¬∞C)' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
            
            const chartClima = new Chart(document.getElementById('chartClima'), {
                type: 'line',
                data: {
                    labels: hours,
                    datasets: [
                        {
                            label: 'Temperatura (¬∞C)',
                            data: [20, 22, 25, 28, 31, 33, 34, 32, 29, 26, 24, 22],
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 3,
                            yAxisID: 'y',
                            pointRadius: 5,
                            pointBackgroundColor: '#f59e0b',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        },
                        {
                            label: 'Umidade (%)',
                            data: [80, 75, 68, 60, 52, 48, 45, 50, 58, 65, 72, 78],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: true,
                            tension: 0.4,
                            borderWidth: 3,
                            yAxisID: 'y1',
                            pointRadius: 5,
                            pointBackgroundColor: '#3b82f6',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: { 
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            padding: 12,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Temperatura (¬∞C)' },
                            grid: { color: '#f5f5f4' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'Umidade (%)' },
                            grid: { drawOnChartArea: false }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
            
            charts.push(chartDeltaT, chartClima);
        }

        // Toast notifications
        function showToast(message, type = 'success') {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.background = type === 'error' ? '#dc2626' : '#15803d';
            toast.innerHTML = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('id_data').value = new Date().toISOString().split('T')[0];
            initBancosDados();
            loadHistory();
            
            // Inicializar com banco vis√≠vel e formul√°rio vis√≠vel
            document.getElementById('produto-banco').style.display = 'block';
            document.getElementById('produto-form').style.display = 'block';
        });
    </script>
</body>
</html>
