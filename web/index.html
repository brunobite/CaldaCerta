<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>CaldaCerta Pro - Login</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Sora:wght@300;400;600;800&display=swap" rel="stylesheet">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <!-- Suas configurações -->
    <script src="./firebase-config.js"></script>
    <script src="./api-config.js"></script>

    <style>
        :root {
            --primary: #0f766e;
            --primary-dark: #065f46;
            --primary-light: #14b8a6;
            --accent: #f59e0b;
            --bg: #fafaf9;
            --card: #ffffff;
            --text: #0c0a09;
            --text-muted: #78716c;
            --border: #e7e5e4;
            --success: #15803d;
            --error: #dc2626;
            --warning: #ea580c;
            --admin: #7c3aed;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Sora', sans-serif;
            background: linear-gradient(135deg, #0f766e 0%, #065f46 100%);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
            overscroll-behavior: none;
            touch-action: manipulation;
        }

        .mono { font-family: 'Space Mono', monospace; }

        /* Layout principal */
        .container {
            max-width: 64rem;
            margin: 0 auto;
            padding: 1rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* Tela de Login (agora é a principal) */
        .login-screen {
            background: white;
            border-radius: 24px;
            padding: 2.5rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            width: 100%;
            max-width: 420px;
            margin: 0 auto;
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-header {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .login-logo {
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .login-logo-accent {
            color: var(--accent);
        }

        .login-subtitle {
            color: var(--text-muted);
            font-size: 1rem;
        }

        .login-icon {
            width: 5rem;
            height: 5rem;
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            color: white;
            font-size: 2rem;
            box-shadow: 0 10px 30px rgba(15, 118, 110, 0.3);
        }

        /* Forms */
        .input-box {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: white;
            font-weight: 600;
            font-size: 1rem;
            color: var(--text);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            outline: none;
            font-family: 'Sora', sans-serif;
            -webkit-appearance: none;
            appearance: none;
            min-height: 3.5rem;
        }

        .input-box:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(15, 118, 110, 0.1);
            transform: translateY(-2px);
        }

        .input-box:hover:not(:focus) {
            border-color: var(--primary-light);
        }

        .label-text {
            display: block;
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
            margin-left: 0.25rem;
        }

        /* Buttons */
        .btn {
            border: none;
            cursor: pointer;
            font-family: 'Sora', sans-serif;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-height: 3rem;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 0.875rem;
            letter-spacing: 0.05em;
            box-shadow: 0 4px 12px rgba(15, 118, 110, 0.3);
            gap: 0.5rem;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(15, 118, 110, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(15, 118, 110, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: white;
            color: var(--text);
            border: 2px solid var(--border);
            font-weight: 700;
            gap: 0.5rem;
        }

        .btn-secondary:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-full { width: 100%; }

        /* Mensagens de erro/sucesso */
        .alert {
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            border-left: 4px solid;
            animation: slideInRight 0.3s ease;
        }

        .alert-success { background: #d1fae5; border-color: #10b981; color: #065f46; }
        .alert-warning { background: #fed7aa; border-color: #f59e0b; color: #9a3412; }
        .alert-danger  { background: #fecaca; border-color: #ef4444; color: #991b1b; }

        .alert-icon { font-size: 1.25rem; flex-shrink: 0; }

        @keyframes slideInRight {
            from { transform: translateX(400px); opacity: 0; }
            to   { transform: translateX(0); opacity: 1; }
        }

        /* Toggle entre login e registro */
        .form-toggle {
            text-align: center;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        .toggle-link {
            color: var(--primary);
            font-weight: 700;
            cursor: pointer;
            text-decoration: none;
            transition: color 0.3s;
        }

        .toggle-link:hover {
            color: var(--primary-dark);
            text-decoration: underline;
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #f3f3f3;
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Versão mobile da tela de login */
        @media (max-width: 768px) {
            .container {
                padding: 0.75rem;
            }
            
            .login-screen {
                padding: 1.5rem;
                border-radius: 16px;
            }
            
            .login-logo {
                font-size: 2rem;
            }
            
            .login-icon {
                width: 4rem;
                height: 4rem;
                font-size: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .login-screen {
                padding: 1.25rem;
            }
            
            .btn {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
            }
        }

        /* Dark mode para login */
        @media (prefers-color-scheme: dark) {
            body {
                background: linear-gradient(135deg, #0c4a6e 0%, #075985 100%);
            }
            
            .login-screen {
                background: #1e293b;
                color: #f1f5f9;
            }
            
            .input-box {
                background: #334155;
                color: #f1f5f9;
                border-color: #475569;
            }
            
            .input-box:focus {
                border-color: var(--primary-light);
            }
            
            .label-text {
                color: #cbd5e1;
            }
            
            .login-subtitle {
                color: #cbd5e1;
            }
            
            .btn-secondary {
                background: #334155;
                color: #f1f5f9;
                border-color: #475569;
            }
            
            .alert-success { background: #064e3b; color: #a7f3d0; }
            .alert-warning { background: #7c2d12; color: #fed7aa; }
            .alert-danger  { background: #7f1d1d; color: #fecaca; }
        }

        /* Navbar (só aparece após login) */
        nav {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none; /* Inicialmente escondido */
        }

        .nav-container {
            max-width: 64rem;
            margin: 0 auto;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            font-size: 1.5rem;
            letter-spacing: -0.02em;
            cursor: pointer;
            user-select: none;
        }

        .user-badge {
            font-size: 0.75rem;
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-height: 2.5rem;
        }

        .admin-badge {
            background: rgba(124, 58, 237, 0.2);
            border-left: 3px solid var(--admin);
        }

        /* Main content (só aparece após login) */
        main {
            display: none; /* Inicialmente escondido */
            background: linear-gradient(135deg, #fafaf9 0%, #f5f5f4 100%);
            min-height: calc(100vh - 70px);
        }

        /* Step Content */
        .step-content {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            animation-duration: 0.4s;
        }

        .step-content.active {
            display: block;
            animation: fadeInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        /* Resto dos estilos (grid, cards, etc) - serão mostrados apenas após login */
        .grid { display: grid; gap: 1rem; }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-1 { gap: 0.25rem; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .gap-6 { gap: 1.5rem; }

        .hidden { display: none !important; }
        .flex-1 { flex: 1; }
        .w-full { width: 100%; }
        .cursor-pointer { cursor: pointer; }
        .opacity-50 { opacity: 0.5; }

        /* Text styles */
        .text-center { text-align: center; }
        .text-white { color: white; }
        .text-slate-500 { color: #64748b; }
        .text-slate-600 { color: #475569; }
        .text-slate-700 { color: #334155; }
        .text-slate-800 { color: #1e293b; }
        .text-slate-900 { color: #0f172a; }
        .text-teal-600 { color: var(--primary); }
        .text-red-600 { color: var(--error); }
        .text-admin { color: var(--admin); }

        .text-xs { font-size: 0.75rem; }
        .text-sm { font-size: 0.875rem; }
        .text-base { font-size: 1rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .text-3xl { font-size: 1.875rem; }
        .text-4xl { font-size: 2.25rem; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        .font-black { font-weight: 800; }
        .uppercase { text-transform: uppercase; }

        /* Spacing */
        .m-0 { margin: 0; }
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .ml-1 { margin-left: 0.25rem; }
        .mr-1 { margin-right: 0.25rem; }
        .mr-2 { margin-right: 0.5rem; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
        .py-16 { padding-top: 4rem; padding-bottom: 4rem; }
        .pb-1 { padding-bottom: 0.25rem; }

        /* Restante dos estilos do app principal */
        /* (Os estilos completos do aplicativo seriam carregados aqui) */
        /* Para manter o código conciso, vou mostrar apenas o essencial */

        /* Footer Navigation */
        footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 2px solid var(--border);
            padding: 1rem;
            z-index: 100;
            box-shadow: 0 -2px 20px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .footer-container {
            max-width: 64rem;
            margin: 0 auto;
            display: flex;
            gap: 1rem;
        }

        .footer-container .btn { flex: 1; }
        .footer-container .btn-primary { flex: 2; }

        /* Cards */
        .card {
            background: var(--card);
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05), 0 10px 30px rgba(0,0,0,0.02);
            border: 1px solid var(--border);
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }

        /* Menu Cards */
        .menu-card {
            background: linear-gradient(135deg, var(--card) 0%, #fafafa 100%);
            border: 2px solid var(--border);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            min-height: 6rem;
        }

        /* Product Items */
        .product-item {
            background: white;
            padding: 1rem;
            border-radius: 12px;
            border-left: 4px solid var(--primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            animation: slideIn 0.3s ease;
            margin-bottom: 0.75rem;
            cursor: move;
            min-height: 80px;
            touch-action: none;
            position: relative;
            -webkit-user-drag: element;
        }

        /* Progress Bar */
        .progress-bar {
            height: 4px;
            background: var(--border);
            border-radius: 9999px;
            overflow: hidden;
            margin-bottom: 2rem;
            position: sticky;
            top: 4.5rem;
            z-index: 40;
            backdrop-filter: blur(10px);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-light), var(--primary));
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Autocomplete */
        .autocomplete-container {
            position: relative;
            width: 100%;
        }

        .autocomplete-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--primary);
            border-top: none;
            border-radius: 0 0 12px 12px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            display: none;
        }

        .autocomplete-result {
            padding: 1rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }

        .autocomplete-result:hover,
        .autocomplete-result.active {
            background: #f0fdfa;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            white-space: nowrap;
        }

        .badge-primary { background: #ccfbf1; color: var(--primary-dark); }
        .badge-admin { background: #ede9fe; color: var(--admin); }

        /* Section Headers */
        .section-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 3px solid var(--primary);
            flex-wrap: wrap;
        }

        .section-number {
            width: 3rem;
            height: 3rem;
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: var(--success);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 9999;
            animation: slideInRight 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
            font-weight: 700;
            max-width: 90vw;
        }

        @keyframes fadeOut { to { opacity: 0; transform: translateY(-20px); } }

        /* Admin Panel */
        .admin-only {
            display: none;
        }

        .admin-only.show {
            display: flex !important;
        }
    </style>
</head>
<body>

    <!-- TELA DE LOGIN (sempre visível inicialmente) -->
    <div id="login-screen" class="container">
        <div class="login-screen">
            <div class="login-header">
                <div class="login-icon">
                    <i class="fa-solid fa-droplet"></i>
                </div>
                <h1 class="login-logo">CALDA<span class="login-logo-accent">CERTA</span></h1>
                <p class="login-subtitle">Gestão Profissional de Caldas Agrícolas</p>
            </div>

            <!-- Mensagem de status -->
            <div id="login-message" class="hidden"></div>

            <!-- Formulário de Login -->
            <div id="login-form-section">
                <div class="mb-6">
                    <label class="label-text">Email</label>
                    <input type="email" id="login-email" class="input-box" placeholder="seu@email.com" autocomplete="email">
                </div>
                
                <div class="mb-6">
                    <label class="label-text">Senha</label>
                    <input type="password" id="login-password" class="input-box" placeholder="Sua senha" autocomplete="current-password">
                </div>
                
                <button onclick="handleLogin()" class="btn btn-primary btn-full mb-4" id="login-btn">
                    <i class="fa-solid fa-sign-in-alt mr-2"></i>
                    Entrar
                </button>
                
                <div class="form-toggle">
                    <p class="text-sm text-slate-600">
                        Não tem uma conta? 
                        <a class="toggle-link" onclick="showRegisterForm()">Crie uma agora</a>
                    </p>
                </div>

                <!-- Modo offline/demo (opcional) -->
                <div class="mt-6 pt-6 border-t border-slate-200">
                    <p class="text-xs text-center text-slate-500 mb-3">
                        Ou use o modo demonstração
                    </p>
                    <button onclick="useDemoMode()" class="btn btn-secondary btn-full">
                        <i class="fa-solid fa-eye mr-2"></i>
                        Modo Demonstração
                    </button>
                </div>
            </div>

            <!-- Formulário de Registro -->
            <div id="register-form-section" class="hidden">
                <div class="mb-6">
                    <label class="label-text">Nome Completo</label>
                    <input type="text" id="register-name" class="input-box" placeholder="Seu nome" autocomplete="name">
                </div>
                
                <div class="mb-6">
                    <label class="label-text">Email</label>
                    <input type="email" id="register-email" class="input-box" placeholder="seu@email.com" autocomplete="email">
                </div>
                
                <div class="mb-6">
                    <label class="label-text">Senha</label>
                    <input type="password" id="register-password" class="input-box" placeholder="Mínimo 6 caracteres" autocomplete="new-password">
                </div>
                
                <div class="mb-6">
                    <label class="label-text">Confirmar Senha</label>
                    <input type="password" id="register-confirm" class="input-box" placeholder="Digite novamente" autocomplete="new-password">
                </div>
                
                <button onclick="handleRegister()" class="btn btn-primary btn-full mb-4" id="register-btn">
                    <i class="fa-solid fa-user-plus mr-2"></i>
                    Criar Conta
                </button>
                
                <div class="form-toggle">
                    <p class="text-sm text-slate-600">
                        Já tem uma conta? 
                        <a class="toggle-link" onclick="showLoginForm()">Faça login</a>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- NAVBAR (após login) -->
    <nav id="main-nav" class="hidden">
        <div class="nav-container">
            <h1 class="logo text-white" onclick="navTo('menu')">
                CALDA<span class="logo-accent">CERTA</span>
            </h1>

            <div class="flex items-center gap-2">
                <!-- Botão de Importar CSV/Excel (SOMENTE ADMIN) -->
                <button id="btn-import" class="user-badge mono btn admin-only" type="button" onclick="showImportModal()" style="border:none; display: none;">
                    <i class="fa-solid fa-file-import"></i>
                    Importar
                </button>
                
                <!-- Botão de Usuário -->
                <button id="btn-user" class="user-badge mono btn" type="button" onclick="showUserMenu()" style="border:none;">
                    <i class="fa-solid fa-user"></i>
                    <span id="user-name">Usuário</span>
                </button>
                
                <!-- Botão de Modo API -->
                <button id="user-display" class="user-badge mono btn" type="button" onclick="toggleApiMode()" style="border:none;">
                    Detectando...
                </button>
            </div>
        </div>
    </nav>

    <!-- CONTEÚDO PRINCIPAL (após login) -->
    <main id="main-content" class="hidden">
        <div class="container" id="app-container">
            <!-- MENU PRINCIPAL -->
            <section id="step-menu" class="step-content">
                <div class="py-16 text-center">
                    <div class="w-20 mx-auto mb-6" style="background: linear-gradient(135deg, #14b8a6, #0f766e); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 30px rgba(15, 118, 110, 0.3);">
                        <i class="fa-solid fa-droplet text-4xl text-white"></i>
                    </div>
                    <h2 class="text-4xl font-black text-slate-900 mb-2">Gestão de Caldas</h2>
                    <p class="text-lg text-slate-600 font-semibold">Simulação e Histórico Digital Profissional</p>
                </div>

                <div class="grid gap-6">
                    <button onclick="startNewSimulation()" class="btn card menu-card relative z-10">
                        <div class="icon-box">
                            <i class="fa-solid fa-plus"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-black text-2xl text-slate-800 mb-1">Nova Simulação</h3>
                            <p class="text-slate-600">Criar novo plano de mistura completo</p>
                        </div>
                        <i class="fa-solid fa-arrow-right icon-arrow"></i>
                    </button>

                    <button onclick="navTo('history')" class="btn card menu-card relative z-10">
                        <div class="icon-box icon-box-green">
                            <i class="fa-solid fa-clock-rotate-left"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-black text-2xl text-slate-800 mb-1">Histórico</h3>
                            <p class="text-slate-600">Consultar simulações salvas</p>
                        </div>
                        <i class="fa-solid fa-arrow-right icon-arrow"></i>
                    </button>
                    
                    <!-- Card de Importação (SOMENTE ADMIN) -->
                    <button id="menu-import" class="btn card menu-card relative z-10 admin-only" onclick="showImportModal()" style="display: none;">
                        <div class="icon-box icon-box-admin">
                            <i class="fa-solid fa-file-excel"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-black text-2xl text-slate-800 mb-1">Importar Dados</h3>
                            <p class="text-slate-600">Carregar CSV/Excel de produtos (Admin)</p>
                        </div>
                        <i class="fa-solid fa-arrow-right icon-arrow"></i>
                    </button>
                    
                    <!-- Card de Gerenciamento (SOMENTE ADMIN) -->
                    <button id="menu-admin" class="btn card menu-card relative z-10 admin-only admin-panel" onclick="showAdminPanel()" style="display: none;">
                        <div class="icon-box icon-box-admin">
                            <i class="fa-solid fa-shield-alt"></i>
                        </div>
                        <div class="flex-1">
                            <h3 class="font-black text-2xl text-slate-800 mb-1">Painel Admin</h3>
                            <p class="text-slate-600">Gerenciar usuários e configurações</p>
                        </div>
                        <i class="fa-solid fa-arrow-right icon-arrow"></i>
                    </button>
                </div>
            </section>

            <!-- PAINEL ADMINISTRATIVO -->
            <section id="step-admin" class="step-content">
                <div class="section-header">
                    <button onclick="navTo('menu')" class="btn btn-icon text-slate-500" style="padding: 0.5rem;">
                        <i class="fa-solid fa-arrow-left text-2xl"></i>
                    </button>
                    <h2 class="text-2xl font-black text-slate-800 flex-1">PAINEL ADMINISTRATIVO</h2>
                    <span class="badge badge-admin"><i class="fa-solid fa-shield-alt mr-1"></i> ADMIN</span>
                </div>

                <div class="card admin-panel">
                    <h3 class="font-bold text-lg mb-4 text-slate-700">
                        <i class="fa-solid fa-users text-admin mr-2"></i>
                        Gerenciamento de Usuários
                    </h3>
                    
                    <div class="search-box">
                        <i class="fa-solid fa-search"></i>
                        <input type="text" id="admin-search" class="input-box" placeholder="Buscar usuários por nome ou email..." oninput="searchUsers()">
                    </div>
                    
                    <div id="users-list" class="mb-6"></div>
                    
                    <h3 class="font-bold text-lg mb-4 text-slate-700">
                        <i class="fa-solid fa-chart-bar text-admin mr-2"></i>
                        Estatísticas do Sistema
                    </h3>
                    
                    <div class="grid grid-3 mb-6">
                        <div class="stat-box" style="background: linear-gradient(135deg, var(--admin), #6d28d9);">
                            <p class="stat-label">Usuários Totais</p>
                            <h4 id="stat-users" class="stat-value">0</h4>
                        </div>
                        <div class="stat-box">
                            <p class="stat-label">Simulações</p>
                            <h4 id="stat-simulations" class="stat-value">0</h4>
                        </div>
                        <div class="stat-box" style="background: linear-gradient(135deg, #10b981, #059669);">
                            <p class="stat-label">Produtos</p>
                            <h4 id="stat-products" class="stat-value">0</h4>
                        </div>
                    </div>
                    
                    <h3 class="font-bold text-lg mb-4 text-slate-700">
                        <i class="fa-solid fa-database text-admin mr-2"></i>
                        Ferramentas Administrativas
                    </h3>
                    
                    <div class="grid grid-2 gap-4">
                        <button onclick="exportDatabase()" class="btn btn-admin">
                            <i class="fa-solid fa-download mr-2"></i>
                            Exportar Dados
                        </button>
                        <button onclick="cleanOldData()" class="btn btn-secondary">
                            <i class="fa-solid fa-broom mr-2"></i>
                            Limpar Dados Antigos
                        </button>
                        <button onclick="showImportModal()" class="btn btn-admin btn-full">
                            <i class="fa-solid fa-file-import mr-2"></i>
                            Importar Produtos
                        </button>
                    </div>
                </div>
            </section>

            <!-- HISTÓRICO -->
            <section id="step-history" class="step-content">
                <div class="section-header">
                    <button onclick="navTo('menu')" class="btn btn-icon text-slate-500" style="padding: 0.5rem;">
                        <i class="fa-solid fa-arrow-left text-2xl"></i>
                    </button>
                    <h2 class="text-2xl font-black text-slate-800 flex-1">HISTÓRICO DE SIMULAÇÕES</h2>
                </div>

                <div class="search-box">
                    <i class="fa-solid fa-search"></i>
                    <input
                        type="text"
                        id="search-history"
                        placeholder="Pesquisar por cliente, propriedade ou cultura..."
                        class="input-box"
                        oninput="filterHistory()"
                    >
                </div>

                <div id="history-list"></div>
                
                <div id="history-loading" class="empty-state hidden">
                    <div class="loading" style="width: 3rem; height: 3rem; border-width: 3px; margin-bottom: 1rem;"></div>
                    <p class="text-xl font-bold">Carregando...</p>
                </div>
                
                <div id="history-empty" class="empty-state hidden">
                    <i class="fa-solid fa-folder-open"></i>
                    <p class="text-xl font-bold">Nenhuma simulação encontrada</p>
                    <p class="mt-2">Crie sua primeira simulação para começar</p>
                </div>

                <div id="pagination" class="pagination hidden"></div>
            </section>

            <!-- ETAPA 2.1: IDENTIFICAÇÃO -->
            <section id="step-2-1" class="step-content">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 16%;"></div>
                </div>

                <div class="section-header">
                    <div class="section-number">1</div>
                    <h2 class="text-2xl font-black text-slate-800 flex-1">IDENTIFICAÇÃO</h2>
                </div>

                <div class="card">
                    <div class="mb-6">
                        <label class="label-text">Cliente *</label>
                        <div class="autocomplete-container">
                            <input type="text" id="id_cliente" class="input-box" placeholder="Nome do cliente" 
                                   oninput="searchAutocomplete('clientes', this.value, 'clientes-list')"
                                   onfocus="showAutocomplete('clientes', 'clientes-list')"
                                   required>
                            <div id="clientes-list" class="autocomplete-results"></div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label class="label-text">Propriedade *</label>
                        <div class="autocomplete-container">
                            <input type="text" id="id_propriedade" class="input-box" placeholder="Nome da propriedade" 
                                   oninput="searchAutocomplete('propriedades', this.value, 'propriedades-list')"
                                   onfocus="showAutocomplete('propriedades', 'propriedades-list')"
                                   required>
                            <div id="propriedades-list" class="autocomplete-results"></div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label class="label-text">Talhão *</label>
                        <div class="autocomplete-container">
                            <input type="text" id="id_talhao" class="input-box" placeholder="Identificação do talhão" 
                                   oninput="searchAutocomplete('talhoes', this.value, 'talhoes-list')"
                                   onfocus="showAutocomplete('talhoes', 'talhoes-list')"
                                   required>
                            <div id="talhoes-list" class="autocomplete-results"></div>
                        </div>
                    </div>

                    <div class="grid grid-2 mb-6">
                        <div>
                            <label class="label-text">Área (hectares) *</label>
                            <input type="number" id="id_area" class="input-box" placeholder="0" step="0.01" min="0" required>
                        </div>
                        <div>
                            <label class="label-text">Data da Aplicação *</label>
                            <input type="date" id="id_data" class="input-box" required>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label class="label-text">Responsável Técnico *</label>
                        <div class="autocomplete-container">
                            <input type="text" id="id_responsavel" class="input-box" placeholder="Nome do responsável técnico" 
                                   oninput="searchAutocomplete('responsaveis', this.value, 'responsaveis-list')"
                                   onfocus="showAutocomplete('responsaveis', 'responsaveis-list')"
                                   required>
                            <div id="responsaveis-list" class="autocomplete-results"></div>
                        </div>
                    </div>

                    <div class="grid grid-2 mb-6">
                        <div>
                            <label class="label-text">Cultura *</label>
                            <select id="id_cultura" class="input-box">
                                <option value="">Selecione...</option>
                                <option value="Soja">Soja</option>
                                <option value="Milho">Milho</option>
                                <option value="Algodão">Algodão</option>
                                <option value="Cana">Cana-de-açúcar</option>
                                <option value="Trigo">Trigo</option>
                                <option value="Arroz">Arroz</option>
                                <option value="Feijão">Feijão</option>
                                <option value="Café">Café</option>
                            </select>
                        </div>
                        <div>
                            <label class="label-text">Objetivo da Aplicação *</label>
                            <select id="id_objetivo" class="input-box">
                                <option value="">Selecione...</option>
                                <option value="Controle de Pragas">Controle de Pragas</option>
                                <option value="Controle de Doenças">Controle de Doenças</option>
                                <option value="Controle de Plantas Daninhas">Controle de Plantas Daninhas</option>
                                <option value="Adubação Foliar">Adubação Foliar</option>
                                <option value="Dessecação">Dessecação</option>
                                <option value="Regulador de Crescimento">Regulador de Crescimento</option>
                            </select>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ETAPA 2.2: EQUIPAMENTO -->
            <section id="step-2-2" class="step-content">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 32%;"></div>
                </div>

                <div class="section-header">
                    <div class="section-number">2</div>
                    <h2 class="text-2xl font-black text-slate-800 flex-1">EQUIPAMENTO E OPERADOR</h2>
                </div>

                <div class="card">
                    <div class="mb-6">
                        <label class="label-text">Capacidade do Tanque (Litros) *</label>
                        <input type="number" id="eq_tanque" class="input-box" placeholder="2000" oninput="calcRendimento()" step="1" min="0" required>
                    </div>

                    <div class="mb-6">
                        <label class="label-text">Vazão (L/ha) *</label>
                        <input type="number" id="eq_vazao" class="input-box" placeholder="200" oninput="calcRendimento()" step="1" min="0" required>
                    </div>

                    <div class="mb-8">
                        <label class="label-text">Operador da Máquina *</label>
                        <div class="autocomplete-container">
                            <input type="text" id="eq_operador" class="input-box" placeholder="Nome do operador" 
                                   oninput="searchAutocomplete('operadores', this.value, 'operadores-list')"
                                   onfocus="showAutocomplete('operadores', 'operadores-list')"
                                   required>
                            <div id="operadores-list" class="autocomplete-results"></div>
                        </div>
                    </div>

                    <div class="stat-box">
                        <p class="stat-label">Rendimento por Tanque</p>
                        <h4 id="res_rendimento" class="stat-value">0.0</h4>
                        <p class="text-sm mt-2" style="opacity: 0.9;">hectares cobertos</p>
                    </div>
                </div>
            </section>

            <!-- ETAPA 2.3: QUALIDADE DA ÁGUA -->
            <section id="step-2-3" class="step-content">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 48%;"></div>
                </div>

                <div class="section-header">
                    <div class="section-number">3</div>
                    <h2 class="text-2xl font-black text-slate-800 flex-1">QUALIDADE DA ÁGUA</h2>
                </div>

                <div class="card">
                    <div class="grid grid-3 mb-6">
                        <div>
                            <label class="label-text">pH da Água</label>
                            <input type="number" id="agua_ph" class="input-box" placeholder="7.0" step="0.1" min="0" max="14">
                        </div>
                        <div>
                            <label class="label-text">Dureza (µS/cm)</label>
                            <input type="number" id="agua_dureza" class="input-box" placeholder="0" step="1" min="0">
                        </div>
                        <div>
                            <label class="label-text">Origem da Água</label>
                            <select id="agua_origem" class="input-box">
                                <option value="Poço">Poço</option>
                                <option value="Rio">Rio</option>
                                <option value="Represa">Represa</option>
                                <option value="Açude">Açude</option>
                                <option value="Rede Pública">Rede Pública</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="label-text">Observações sobre a Água</label>
                        <textarea id="agua_obs" class="input-box" rows="3" placeholder="Ex: Água limpa, sem resíduos visíveis"></textarea>
                    </div>
                </div>
            </section>

            <!-- ETAPA 2.4: CLIMA -->
            <section id="step-2-4" class="step-content">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 64%;"></div>
                </div>

                <div class="section-header">
                    <div class="section-number">4</div>
                    <h2 class="text-2xl font-black text-slate-800 flex-1">CONDIÇÕES CLIMÁTICAS</h2>
                </div>

                <div class="card">
                    <h3 class="font-bold text-lg mb-4 text-slate-700">
                        <i class="fa-solid fa-chart-line text-teal-600 mr-2"></i>
                        Delta T (Diferencial de Temperatura)
                    </h3>
                    <div class="chart-container">
                        <canvas id="chartDeltaT" height="200"></canvas>
                    </div>

                    <div id="alert-container" class="mb-6"></div>

                    <h3 class="font-bold text-lg mb-4 text-slate-700">
                        <i class="fa-solid fa-temperature-high mr-2" style="color: #f59e0b;"></i>
                        Temperatura e Umidade
                    </h3>
                    <div class="chart-container">
                        <canvas id="chartClima" height="200"></canvas>
                    </div>
                </div>
            </section>

            <!-- ETAPA 2.5: PRODUTOS -->
            <section id="step-2-5" class="step-content">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 80%;"></div>
                </div>

                <div class="section-header">
                    <div class="section-number">5</div>
                    <h2 class="text-2xl font-black text-slate-800 flex-1">PRODUTOS</h2>
                </div>

                <div class="card">
                    <div class="mb-4 flex items-center justify-between">
                        <h3 class="text-sm font-bold text-slate-700 uppercase">Adicionar Produto</h3>
                        <div class="flex gap-2">
                            <button onclick="toggleNovoOuBanco()" class="text-xs font-bold text-teal-600 hover:text-teal-800 transition-colors" style="background:transparent;border:none;cursor:pointer;">
                                <i class="fa-solid fa-exchange-alt mr-1"></i>
                                <span id="toggle-text">Produto Novo</span>
                            </button>
                            <button onclick="showEditModal(null)" class="text-xs font-bold text-teal-600 hover:text-teal-800 transition-colors" style="background:transparent;border:none;cursor:pointer;">
                                <i class="fa-solid fa-pen mr-1"></i>
                                Editar
                            </button>
                        </div>
                    </div>

                    <!-- Seleção do Banco de Dados -->
                    <div id="produto-banco" class="mb-6">
                        <label class="label-text">Buscar no Banco de Produtos</label>
                        <div class="autocomplete-container">
                            <input type="text" id="p_banco_search" class="input-box" 
                                   placeholder="Digite para buscar..."
                                   oninput="searchProdutos(this.value)"
                                   onfocus="showProdutosAutocomplete()">
                            <div id="p_banco_results" class="autocomplete-results"></div>
                        </div>
                        <p class="text-xs text-slate-500 mt-2">Selecione um produto e informe a dose abaixo</p>
                    </div>

                    <!-- Formulário de Produto -->
                    <div id="produto-form">
                        <div class="grid grid-2 mb-6">
                            <div>
                                <label class="label-text">Nome do Produto *</label>
                                <input type="text" id="p_nome" class="input-box" placeholder="Ex: Glifosato 480">
                            </div>
                            <div>
                                <label class="label-text">Marca Comercial</label>
                                <input type="text" id="p_marca" class="input-box" placeholder="Ex: Roundup">
                            </div>
                        </div>

                        <div class="grid grid-3 mb-6">
                            <div>
                                <label class="label-text">Formulação *</label>
                                <select id="p_formulacao" class="input-box">
                                    <option value="SC">SC - Suspensão Concentrada</option>
                                    <option value="CE">CE - Concentrado Emulsionável</option>
                                    <option value="WG">WG - Granulado Dispersível</option>
                                    <option value="EW">EW - Emulsão Água/Óleo</option>
                                    <option value="OD">OD - Dispersão Oleosa</option>
                                    <option value="ADJUVANTE">Adjuvante</option>
                                    <option value="ESPALHANTE">Espalhante</option>
                                    <option value="ANTIESPUMA">Anti-espuma</option>
                                    <option value="FERTILIZANTE">Fertilizante</option>
                                    <option value="OLEO">Óleo</option>
                                </select>
                            </div>
                            <div>
                                <label class="label-text">Tipo de Produto</label>
                                <select id="p_tipo" class="input-box">
                                    <option value="PRODUTO">Produto Fitossanitário</option>
                                    <option value="ADJUVANTE">Adjuvante/Espalhante/Anti-espuma</option>
                                    <option value="FERTILIZANTE">Fertilizante</option>
                                    <option value="OLEO">Óleo Mineral/Vegetal</option>
                                </select>
                            </div>
                            <div>
                                <label class="label-text">pH da Calda</label>
                                <input type="number" id="p_ph" class="input-box" placeholder="Ex: 6.5" step="0.1" min="0" max="14">
                            </div>
                        </div>

                        <div class="mb-6">
                            <label class="label-text">Dose (L ou Kg/ha) *</label>
                            <input type="number" id="p_dose" class="input-box" placeholder="0.00" step="0.01" min="0">
                        </div>
                    </div>

                    <button onclick="addProduto()" class="btn btn-primary btn-full">
                        <i class="fa-solid fa-plus"></i>
                        Adicionar Produto à Lista
                    </button>
                </div>

                <div id="lista-produtos"></div>
                <div id="produtos-empty" class="empty-state hidden">
                    <i class="fa-solid fa-box-open"></i>
                    <p class="text-lg font-bold">Nenhum produto adicionado</p>
                    <p class="mt-2">Adicione produtos para continuar</p>
                </div>
            </section>

            <!-- ETAPA 2.6: FINALIZAÇÃO -->
            <section id="step-2-6" class="step-content">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 100%;"></div>
                </div>

                <div class="section-header">
                    <div class="section-number">
                        <i class="fa-solid fa-check"></i>
                    </div>
                    <h2 class="text-2xl font-black text-slate-800 flex-1">ORDEM DE MISTURA</h2>
                </div>

                <div class="card card-compact mb-6">
                    <label class="label-text">Volume da Jarra Teste</label>
                    <select id="jarra_vol" class="input-box" style="margin-bottom: 0;" onchange="renderOrdem()">
                        <option value="500">500 ml</option>
                        <option value="1000" selected>1000 ml (1 Litro)</option>
                        <option value="1500">1500 ml (1,5 Litros)</option>
                        <option value="2000">2000 ml (2 Litros)</option>
                    </select>
                </div>

                <div class="card card-compact mb-6">
                    <div class="checkbox-container mb-4">
                        <input type="checkbox" id="respeitarHierarquia" checked onchange="toggleHierarchyOptions()">
                        <label for="respeitarHierarquia" class="font-bold text-sm" style="cursor: pointer;">
                            Respeitar hierarquia de mistura
                        </label>
                    </div>

                    <div id="hierarchyOptions" class="mt-4">
                        <label class="label-text">Critério de Ordenação dos Produtos (2ª Ordem)</label>
                        <select id="criterioOrdenacao" class="input-box" style="margin-bottom: 0;" onchange="renderOrdem()">
                            <option value="tipo">Por Tipo de Solução (Padrão)</option>
                            <option value="ph-crescente">pH Crescente (Menor → Maior)</option>
                            <option value="ph-decrescente">pH Decrescente (Maior → Menor)</option>
                        </select>
                        <p class="text-xs text-slate-500 mt-2 ml-1">
                            <strong>Hierarquia:</strong> 1° Adjuvantes → 2° Produtos (ordenados pelo critério) → 3° Fertilizantes → 4° Óleos
                        </p>
                    </div>
                </div>

                <h3 class="font-bold text-lg mb-4 text-slate-700">
                    <i class="fa-solid fa-flask text-teal-600 mr-2"></i>
                    Ordem de Mistura (Arraste para reordenar)
                </h3>
                
                <div class="mb-4">
                    <button onclick="enableEditMode()" class="btn btn-secondary btn-sm" id="btn-edit-mode">
                        <i class="fa-solid fa-pen mr-1"></i>
                        Modo Edição
                    </button>
                    <button onclick="saveOrder()" class="btn btn-primary btn-sm hidden" id="btn-save-order">
                        <i class="fa-solid fa-save mr-1"></i>
                        Salvar Ordem
                    </button>
                </div>
                
                <div class="ordem-scroll-container" id="ordem-scroll-container">
                    <div id="ordem-container" class="ordem-inner mb-8"></div>
                </div>

                <div class="grid grid-2 mb-6">
                    <button onclick="navTo('2-5')" class="btn btn-secondary">
                        <i class="fa-solid fa-arrow-left text-xl"></i>
                        <span class="font-bold">Voltar aos Produtos</span>
                    </button>

                    <button onclick="generatePDF()" class="btn btn-secondary">
                        <i class="fa-solid fa-file-pdf text-red-600 text-xl"></i>
                        <span class="font-bold">Gerar PDF</span>
                    </button>
                </div>

                <button id="btn-save-cloud" onclick="saveSimulation()" class="btn btn-primary btn-full mb-6">
                    <i class="fa-solid fa-save text-xl"></i>
                    Salvar Simulação Completa
                </button>

                <button onclick="navTo('menu')" class="btn btn-full py-4 text-slate-500 font-bold uppercase text-sm transition-colors" style="background: transparent; border: none;">
                    <i class="fa-solid fa-home mr-2"></i>
                    Voltar ao Menu Principal
                </button>
            </section>
        </div>
    </main>

    <!-- Navegação Inferior (após login) -->
    <footer id="app-nav" class="hidden">
        <div class="footer-container">
            <button id="btn-prev" onclick="handlePrev()" class="btn btn-secondary">
                <i class="fa-solid fa-chevron-left mr-2"></i>
                Anterior
            </button>
            <button id="btn-next" onclick="handleNext()" class="btn btn-primary">
                Próximo
                <i class="fa-solid fa-chevron-right"></i>
            </button>
        </div>
    </footer>

    <!-- Modal de Importação (SOMENTE ADMIN) -->
    <div id="import-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h2 class="text-2xl font-black text-slate-800">
                    <i class="fa-solid fa-shield-alt text-admin mr-2"></i>
                    Importar Dados (Admin)
                </h2>
                <button class="close-modal" onclick="hideImportModal()">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            
            <div class="mb-6">
                <p class="text-slate-600 mb-4">Importe produtos de arquivos CSV ou Excel (.xlsx, .xls) - Acesso restrito a administradores</p>
                
                <div class="file-upload-container" onclick="document.getElementById('file-input').click()" 
                     ondrop="handleFileDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                    <i class="fa-solid fa-cloud-upload-alt upload-icon"></i>
                    <p class="font-bold mb-2">Arraste e solte arquivos aqui</p>
                    <p class="text-sm text-slate-500 mb-4">ou clique para selecionar</p>
                    <button class="btn btn-secondary">
                        <i class="fa-solid fa-folder-open mr-2"></i>
                        Selecionar Arquivo
                    </button>
                    <input type="file" id="file-input" class="file-input" accept=".csv,.xlsx,.xls" onchange="handleFileSelect(event)">
                </div>
                
                <div class="mt-4">
                    <p class="text-xs text-slate-500 mb-2">Formato esperado (CSV):</p>
                    <div class="bg-slate-100 p-3 rounded-lg text-sm font-mono overflow-x-auto">
                        nome,marca,formulacao,tipo,ph,dose<br>
                        Glifosato 480,Roundup,CE,PRODUTO,6.5,2.0<br>
                        Adjuvante X,AgroMax,ADJUVANTE,,0.5
                    </div>
                </div>
            </div>
            
            <div id="import-preview" class="hidden">
                <h4 class="font-bold mb-3">Pré-visualização (10 primeiras linhas):</h4>
                <div id="preview-table" class="mb-4 overflow-x-auto"></div>
                
                <button onclick="confirmImport()" class="btn btn-admin btn-full">
                    <i class="fa-solid fa-check mr-2"></i>
                    Confirmar Importação (Admin)
                </button>
            </div>
            
            <div id="import-progress" class="hidden">
                <div class="text-center">
                    <div class="loading mb-4" style="width: 3rem; height: 3rem; border-width: 3px; margin: 0 auto;"></div>
                    <p class="font-bold" id="progress-text">Importando dados...</p>
                    <div class="progress-bar mt-4" style="height: 8px;">
                        <div class="progress-fill" id="import-progress-bar" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Edição de Produto -->
    <div id="edit-modal-overlay" class="edit-modal-overlay hidden"></div>
    <div id="edit-modal" class="edit-modal hidden">
        <div class="modal-header mb-6">
            <h2 class="text-2xl font-black text-slate-800">Editar Produto</h2>
            <button class="close-modal" onclick="hideEditModal()">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>
        
        <div id="edit-form">
            <div class="mb-6">
                <label class="label-text">Nome do Produto *</label>
                <input type="text" id="edit-nome" class="input-box" placeholder="Nome do produto">
            </div>
            
            <div class="mb-6">
                <label class="label-text">Marca Comercial</label>
                <input type="text" id="edit-marca" class="input-box" placeholder="Marca">
            </div>
            
            <div class="grid grid-2 mb-6">
                <div>
                    <label class="label-text">Formulação *</label>
                    <select id="edit-formulacao" class="input-box">
                        <option value="SC">SC - Suspensão Concentrada</option>
                        <option value="CE">CE - Concentrado Emulsionável</option>
                        <option value="WG">WG - Granulado Dispersível</option>
                        <option value="EW">EW - Emulsão Água/Óleo</option>
                        <option value="OD">OD - Dispersão Oleosa</option>
                        <option value="ADJUVANTE">Adjuvante</option>
                        <option value="ESPALHANTE">Espalhante</option>
                        <option value="ANTIESPUMA">Anti-espuma</option>
                        <option value="FERTILIZANTE">Fertilizante</option>
                        <option value="OLEO">Óleo</option>
                    </select>
                </div>
                <div>
                    <label class="label-text">Tipo</label>
                    <select id="edit-tipo" class="input-box">
                        <option value="PRODUTO">Produto Fitossanitário</option>
                        <option value="ADJUVANTE">Adjuvante/Espalhante/Anti-espuma</option>
                        <option value="FERTILIZANTE">Fertilizante</option>
                        <option value="OLEO">Óleo Mineral/Vegetal</option>
                    </select>
                </div>
            </div>
            
            <div class="grid grid-2 mb-6">
                <div>
                    <label class="label-text">pH da Calda</label>
                    <input type="number" id="edit-ph" class="input-box" placeholder="Ex: 6.5" step="0.1">
                </div>
                <div>
                    <label class="label-text">Dose (L ou Kg/ha) *</label>
                    <input type="number" id="edit-dose" class="input-box" placeholder="0.00" step="0.01">
                </div>
            </div>
            
            <div class="flex gap-4">
                <button onclick="saveEditedProduct()" class="btn btn-primary flex-1">
                    <i class="fa-solid fa-save mr-2"></i>
                    Salvar
                </button>
                <button onclick="deleteProduct()" class="btn btn-danger">
                    <i class="fa-solid fa-trash mr-2"></i>
                    Excluir
                </button>
            </div>
        </div>
    </div>

    <script>
        // APLICATIVO QUE ABRE DIRETAMENTE NA TELA DE LOGIN
        // O conteúdo principal só é mostrado após autenticação

        let products = [];
        let historicalData = [];
        let currentStepIdx = 0;
        const steps = ['menu', 'admin', 'history', '2-1', '2-2', '2-3', '2-4', '2-5', '2-6'];
        let sortableInstance = null;
        let currentUser = null;
        let isEditMode = false;
        let currentEditProduct = null;
        let isAdmin = false;
        let isDemoMode = false;

        // Configurações de paginação
        const ITEMS_PER_PAGE = 10;
        let currentPage = 1;
        let totalPages = 1;

        // Bancos de dados
        let bancoProdutos = [];
        let bancoClientes = [];
        let bancoPropriedades = [];
        let bancoTalhoes = [];
        let bancoResponsaveis = [];
        let bancoOperadores = [];

        // Dados para importação
        let importData = [];

        // ✅ Lista de administradores
        const ADMIN_EMAILS = [
            'admin@caldacerta.com',
            'administrador@empresa.com',
            'gerente.tecnico@empresa.com'
        ];

        // ✅ SISTEMA DE AUTENTICAÇÃO - TELA INICIAL
        function initAuth() {
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    // Usuário já está logado (sessão salva)
                    currentUser = user;
                    isAdmin = checkIfAdmin(user);
                    showMainApp();
                } else {
                    // Mostrar tela de login
                    showLoginScreen();
                }
            });
        }

        function checkIfAdmin(user) {
            return ADMIN_EMAILS.includes(user.email.toLowerCase());
        }

        function showLoginScreen() {
            // Mostrar tela de login, esconder app principal
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('main-nav').style.display = 'none';
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('app-nav').style.display = 'none';
            
            // Resetar formulários
            showLoginForm();
            clearLoginForm();
        }

        function showMainApp() {
            // Esconder tela de login, mostrar app principal
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-nav').style.display = 'block';
            document.getElementById('main-content').style.display = 'block';
            
            // Atualizar UI do usuário
            updateUIForUser(currentUser);
            
            // Inicializar app
            initBancosDados();
            loadHistory();
            navTo('menu');
            
            // Mostrar mensagem de boas-vindas
            showToast(`👋 Bem-vindo, ${currentUser.displayName || currentUser.email.split('@')[0]}!`, 'success');
        }

        function updateUIForUser(user) {
            const btnUser = document.getElementById('btn-user');
            const userName = document.getElementById('user-name');
            const displayName = user.displayName || user.email.split('@')[0];
            
            if (isAdmin) {
                btnUser.innerHTML = `<i class="fa-solid fa-shield-alt"></i> ${displayName}`;
                btnUser.classList.add('admin-badge');
            } else {
                btnUser.innerHTML = `<i class="fa-solid fa-user"></i> ${displayName}`;
                btnUser.classList.remove('admin-badge');
            }
            
            btnUser.title = `${user.email}${isAdmin ? ' (Admin)' : ''}`;
            userName.textContent = displayName;
            
            // Mostrar/ocultar elementos de admin
            toggleAdminElements(isAdmin);
        }

        function toggleAdminElements(show) {
            const adminElements = document.querySelectorAll('.admin-only');
            adminElements.forEach(el => {
                if (show) {
                    el.style.display = 'flex';
                } else {
                    el.style.display = 'none';
                }
            });
        }

        function showLoginForm() {
            document.getElementById('login-form-section').classList.remove('hidden');
            document.getElementById('register-form-section').classList.add('hidden');
            clearLoginMessage();
        }

        function showRegisterForm() {
            document.getElementById('login-form-section').classList.add('hidden');
            document.getElementById('register-form-section').classList.remove('hidden');
            clearLoginMessage();
        }

        function clearLoginForm() {
            document.getElementById('login-email').value = '';
            document.getElementById('login-password').value = '';
            document.getElementById('register-name').value = '';
            document.getElementById('register-email').value = '';
            document.getElementById('register-password').value = '';
            document.getElementById('register-confirm').value = '';
        }

        function showLoginMessage(message, type = 'error') {
            const messageDiv = document.getElementById('login-message');
            messageDiv.className = `alert alert-${type}`;
            messageDiv.innerHTML = `
                <i class="fa-solid ${type === 'error' ? 'fa-triangle-exclamation' : 'fa-circle-check'} alert-icon"></i>
                <div>${message}</div>
            `;
            messageDiv.classList.remove('hidden');
        }

        function clearLoginMessage() {
            document.getElementById('login-message').classList.add('hidden');
        }

        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const loginBtn = document.getElementById('login-btn');
            
            if (!email || !password) {
                showLoginMessage('❌ Preencha email e senha', 'error');
                return;
            }
            
            // Mostrar loading
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<div class="loading mr-2"></div> Entrando...';
            
            try {
                await firebase.auth().signInWithEmailAndPassword(email, password);
                // O onAuthStateChanged vai capturar o login e mostrar o app
            } catch (error) {
                console.error('Erro no login:', error);
                
                let errorMessage = 'Erro ao fazer login';
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'Usuário não encontrado';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Senha incorreta';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Muitas tentativas. Tente novamente mais tarde';
                }
                
                showLoginMessage(`❌ ${errorMessage}`, 'error');
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fa-solid fa-sign-in-alt mr-2"></i> Entrar';
            }
        }

        async function handleRegister() {
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirm = document.getElementById('register-confirm').value;
            const registerBtn = document.getElementById('register-btn');
            
            if (!name || !email || !password || !confirm) {
                showLoginMessage('❌ Preencha todos os campos', 'error');
                return;
            }
            
            if (password !== confirm) {
                showLoginMessage('❌ As senhas não coincidem', 'error');
                return;
            }
            
            if (password.length < 6) {
                showLoginMessage('❌ A senha deve ter pelo menos 6 caracteres', 'error');
                return;
            }
            
            // Mostrar loading
            registerBtn.disabled = true;
            registerBtn.innerHTML = '<div class="loading mr-2"></div> Criando conta...';
            
            try {
                const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
                await userCredential.user.updateProfile({
                    displayName: name
                });
                
                // Registrar na API
                try {
                    await API.registerUser({
                        uid: userCredential.user.uid,
                        email: email,
                        name: name,
                        role: 'technician',
                        createdAt: new Date().toISOString()
                    });
                } catch (apiError) {
                    console.warn('API de usuários não disponível:', apiError);
                }
                
                showLoginMessage('✅ Conta criada com sucesso!', 'success');
                setTimeout(() => {
                    showLoginForm();
                    document.getElementById('login-email').value = email;
                    document.getElementById('login-password').value = password;
                }, 1500);
                
            } catch (error) {
                console.error('Erro no cadastro:', error);
                
                let errorMessage = 'Erro ao criar conta';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Email já está em uso';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Email inválido';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Senha muito fraca';
                }
                
                showLoginMessage(`❌ ${errorMessage}`, 'error');
            } finally {
                registerBtn.disabled = false;
                registerBtn.innerHTML = '<i class="fa-solid fa-user-plus mr-2"></i> Criar Conta';
            }
        }

        function useDemoMode() {
            isDemoMode = true;
            currentUser = {
                uid: 'demo-user',
                email: 'demo@caldacerta.com',
                displayName: 'Usuário Demo'
            };
            isAdmin = false;
            
            showMainApp();
            showToast('🔓 Modo demonstração ativado', 'warning');
        }

        function showUserMenu() {
            // Criar menu suspenso simples
            if (confirm('Deseja sair da sua conta?')) {
                handleLogout();
            }
        }

        async function handleLogout() {
            try {
                await firebase.auth().signOut();
                isDemoMode = false;
                currentUser = null;
                isAdmin = false;
                showLoginScreen();
                showToast('✅ Logout realizado com sucesso', 'success');
            } catch (error) {
                console.error('Erro no logout:', error);
                showToast('❌ Erro ao fazer logout', 'error');
            }
        }

        // ✅ MODO API
        function getModoAtual() {
            const forced = (localStorage.getItem("MODO_API") || "").toLowerCase();
            if (forced === "local") return "local";
            if (forced === "remoto") return "remoto";

            const base = (window.API_BASE || "");
            return base.includes("localhost") ? "local" : "remoto";
        }

        function atualizarBadgeModo() {
            const btn = document.getElementById("user-display");
            if (!btn) return;

            const modo = getModoAtual();
            const host = location.hostname;
            const base = window.API_BASE || "(não definido)";

            if (modo === "local") {
                btn.textContent = "Modo Local";
                btn.title = `Usando API local (${base}) | host=${host}`;
            } else {
                btn.textContent = "Modo Remoto";
                btn.title = `Usando API remoto (${base}) | host=${host}`;
            }
        }

        window.toggleApiMode = () => {
            const modo = getModoAtual();
            localStorage.setItem("MODO_API", modo === "local" ? "remoto" : "local");
            location.reload();
        };

        // ✅ PAINEL ADMINISTRATIVO
        function showAdminPanel() {
            if (!isAdmin) {
                showToast('❌ Acesso restrito a administradores', 'error');
                return;
            }
            
            navTo('admin');
            loadAdminStats();
            loadUsersList();
        }

        async function loadAdminStats() {
            if (!isAdmin) return;
            
            try {
                const users = await API.getUsers();
                const simulations = await API.getSimulacoes();
                const products = await API.getProdutos();
                
                document.getElementById('stat-users').textContent = users.length;
                document.getElementById('stat-simulations').textContent = simulations.length;
                document.getElementById('stat-products').textContent = products.length;
            } catch (error) {
                console.error('Erro ao carregar estatísticas:', error);
            }
        }

        async function loadUsersList() {
            if (!isAdmin) return;
            
            try {
                const users = await API.getUsers();
                const list = document.getElementById('users-list');
                
                if (users.length === 0) {
                    list.innerHTML = '<p class="text-slate-500 text-center py-4">Nenhum usuário encontrado</p>';
                    return;
                }
                
                list.innerHTML = users.map(user => {
                    const isUserAdmin = ADMIN_EMAILS.includes(user.email.toLowerCase());
                    const lastLogin = user.lastLogin ? new Date(user.lastLogin).toLocaleDateString('pt-BR') : 'Nunca';
                    const createdAt = user.createdAt ? new Date(user.createdAt).toLocaleDateString('pt-BR') : '-';
                    
                    return `
                        <div class="card card-compact mb-4">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-bold text-slate-800">${user.name || user.email}</h4>
                                    <p class="text-sm text-slate-600">${user.email}</p>
                                    <div class="flex gap-2 mt-2">
                                        ${isUserAdmin ? 
                                            '<span class="badge badge-admin"><i class="fa-solid fa-shield-alt mr-1"></i> Admin</span>' : 
                                            '<span class="badge badge-primary"><i class="fa-solid fa-user-tie mr-1"></i> Técnico</span>'
                                        }
                                        <span class="text-xs text-slate-500">Criado: ${createdAt}</span>
                                        <span class="text-xs text-slate-500">Último login: ${lastLogin}</span>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    ${!isUserAdmin ? 
                                        `<button onclick="promoteToAdmin('${user.email}')" class="btn btn-admin btn-sm" title="Tornar administrador">
                                            <i class="fa-solid fa-shield-alt"></i>
                                        </button>` : ''
                                    }
                                    <button onclick="resetUserPassword('${user.email}')" class="btn btn-secondary btn-sm" title="Redefinir senha">
                                        <i class="fa-solid fa-key"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Erro ao carregar usuários:', error);
                showToast('❌ Erro ao carregar lista de usuários', 'error');
            }
        }

        // ✅ NAVEGAÇÃO
        window.navTo = (id) => {
            // Se tentar acessar admin sem permissão, bloquear
            if (id === 'admin' && !isAdmin) {
                showToast('❌ Acesso restrito a administradores', 'error');
                navTo('menu');
                return;
            }
            
            currentStepIdx = steps.indexOf(id);
            
            if (currentStepIdx === -1) {
                console.error('Step não encontrado:', id);
                return;
            }

            document.querySelectorAll('.step-content').forEach(s => s.classList.remove('active'));
            const target = document.getElementById(`step-${id}`);
            if (target) {
                target.classList.add('active');
            }

            const footer = document.getElementById('app-nav');
            const isMenu = id === 'menu' || id === 'history' || id === 'admin';
            const isLast = id === '2-6';

            if (footer) {
                footer.classList.toggle('hidden', isMenu || isLast);
            }
            
            if (document.getElementById('btn-prev')) {
                document.getElementById('btn-prev').classList.toggle('hidden', currentStepIdx <= 3); // 3 porque temos menu, admin, history antes das etapas
            }

            if (id === '2-4') {
                initCharts();
                checkClimateConditions();
            }
            if (id === '2-6') {
                const btnSave = document.getElementById('btn-save-cloud');
                if (btnSave) {
                    btnSave.disabled = false;
                    btnSave.innerHTML = '<i class="fa-solid fa-save text-xl"></i> Salvar Simulação';
                    btnSave.classList.remove('opacity-50');
                }
                renderOrdem();
            }

            window.scrollTo({top: 0, behavior: 'smooth'});
        };

        window.handleNext = () => {
            if (currentStepIdx === 3) { // IDENTIFICAÇÃO
                const cliente = document.getElementById('id_cliente').value;
                if (!cliente) {
                    showToast('❌ Preencha o nome do cliente', 'error');
                    return;
                }
            }

            if (currentStepIdx === 4) { // EQUIPAMENTO
                const tanque = document.getElementById('eq_tanque').value;
                const vazao = document.getElementById('eq_vazao').value;
                if (!tanque || !vazao) {
                    showToast('❌ Preencha os dados do equipamento', 'error');
                    return;
                }
            }

            if (currentStepIdx === 7) { // PRODUTOS
                if (products.length === 0) {
                    showToast('❌ Adicione pelo menos um produto', 'error');
                    return;
                }
            }

            if (currentStepIdx < steps.length - 1) navTo(steps[currentStepIdx + 1]);
        };

        window.handlePrev = () => {
            if (currentStepIdx > 0) navTo(steps[currentStepIdx - 1]);
        };

        window.startNewSimulation = () => {
            products = [];
            renderProductList();
            document.querySelectorAll('input').forEach(i => {
                if (i.type !== 'date' && i.type !== 'checkbox') i.value = "";
            });
            document.querySelectorAll('textarea').forEach(t => t.value = "");
            document.getElementById('id_data').value = new Date().toISOString().split('T')[0];
            document.getElementById('id_cultura').selectedIndex = 0;
            document.getElementById('id_objetivo').selectedIndex = 0;
            document.getElementById('res_rendimento').innerText = "0.0";
            document.getElementById('respeitarHierarquia').checked = true;
            navTo('2-1');
        };

        // ✅ FUNÇÕES RESTANTES DO APLICATIVO
        // (Estas funções seriam as mesmas do código anterior, adaptadas para o novo fluxo)

        // ✅ INICIALIZAÇÃO
        document.addEventListener('DOMContentLoaded', () => {
            // Configurar data atual
            document.getElementById('id_data').value = new Date().toISOString().split('T')[0];
            
            // Inicializar Firebase Auth
            initAuth();
            
            // Mostrar modo API
            atualizarBadgeModo();
            
            // Configurar toggle inicial de produtos
            document.getElementById('produto-banco').style.display = 'block';
            document.getElementById('produto-form').style.display = 'block';
            
            // Configurar outros eventos
            document.getElementById('edit-modal-overlay').onclick = hideEditModal;
            
            // Melhorar scroll em mobile
            document.querySelectorAll('.ordem-scroll-container').forEach(container => {
                container.addEventListener('touchmove', (e) => {
                    if (!sortableInstance || !sortableInstance.dragging) {
                        return;
                    }
                    e.preventDefault();
                }, { passive: false });
            });
            
            // Fechar modais com ESC
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (!document.getElementById('import-modal').classList.contains('hidden')) {
                        hideImportModal();
                    }
                    if (!document.getElementById('edit-modal').classList.contains('hidden')) {
                        hideEditModal();
                    }
                }
            });
            
            // Focar no campo de email ao carregar
            setTimeout(() => {
                const emailInput = document.getElementById('login-email');
                if (emailInput) emailInput.focus();
            }, 300);
        });

        // ✅ TOAST FUNCTION
        function showToast(message, type = 'success') {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.background = type === 'error' ? '#dc2626' : 
                                    type === 'warning' ? '#ea580c' : '#15803d';
            toast.innerHTML = message;
            document.body.appendChild(toast);

            setTimeout(() => toast.remove(), 3000);
        }

        // ✅ Nota: As demais funções do aplicativo (initBancosDados, searchAutocomplete, etc.)
        // seriam mantidas como no código anterior, apenas ajustadas para o novo fluxo
        // onde o app só é inicializado após o login.

        // ✅ API CONFIGURAÇÃO
        if (window.API && typeof window.API === 'object') {
            window.API.registerUser = async function(userData) {
                try {
                    const response = await fetch(`${window.API_BASE}/register-user`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(userData)
                    });
                    
                    if (!response.ok) throw new Error('Erro ao registrar usuário');
                    return await response.json();
                } catch (error) {
                    console.error('API registerUser error:', error);
                    throw error;
                }
            };

            window.API.getUsers = async function() {
                try {
                    const response = await fetch(`${window.API_BASE}/users`);
                    if (!response.ok) throw new Error('Erro ao buscar usuários');
                    return await response.json();
                } catch (error) {
                    console.error('API getUsers error:', error);
                    return [];
                }
            };
        }
    </script>
</body>
</html>